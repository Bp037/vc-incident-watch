<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>VC Incident Watch</title>

  <meta name="theme-color" content="#000000" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-title" content="VC Incident Watch" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <link rel="apple-touch-icon" href="/icons/icon-192.png" />

  <link rel="preconnect" href="https://unpkg.com" crossorigin>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
          integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

  <style>
    :root{
      --bg:#000;
      --ink:#f4f4f5;
      --muted:rgba(255,255,255,.72);
      --muted2:rgba(255,255,255,.45);
      --link:#60a5fa;

      --hdr:#8c1111;
      --hdrOutline:#000;

      --card:rgba(255,255,255,.03);
      --cardBorder:rgba(255,255,255,.08);

      --rowA:rgba(255,255,255,.02);
      --rowB:rgba(255,255,255,.04);

      --greenLine:rgba(16,185,129,.35);
      --shadow:rgba(0,0,0,.55);
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background:var(--bg);
      color:var(--ink);
    }
    a{ color:var(--link); text-decoration:none; }
    a:hover{ text-decoration:underline; }

    header{ position:sticky; top:0; z-index:50; background:var(--bg); }
    header .bar{
      background:var(--hdr);
      outline:2px solid var(--hdrOutline);
      box-shadow: 0 6px 18px var(--shadow);
    }
    .wrap{
      max-width:1120px; margin:0 auto; padding:14px 16px;
      display:flex; align-items:center; justify-content:space-between; gap:12px;
    }
    .title{ display:flex; flex-direction:column; gap:2px; }
    .title h1{ margin:0; font-size:18px; font-weight:750; letter-spacing:.2px; }
    .title p{ margin:0; font-size:12px; color:rgba(255,255,255,.82); }

    .statusBox{ display:flex; align-items:center; gap:10px; white-space:nowrap; font-size:12px; }
    .dot{ width:10px;height:10px;border-radius:999px; background:rgba(255,255,255,.35); box-shadow:0 0 0 2px rgba(0,0,0,.25) inset; }
    .dot.ok{ background:#34d399; }
    .dot.wait{ background:#fbbf24; }
    .dot.err{ background:#fb7185; }
    .adminLink{
      font-size:11px;
      padding:4px 8px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.2);
      color:var(--link);
      background:rgba(0,0,0,.25);
    }

    .tabsWrap{
      max-width:1120px;
      margin:0 auto;
      padding:10px 16px 14px;
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
    }
    .tabBtn{
      appearance:none;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.25);
      color:rgba(255,255,255,.92);
      border-radius:999px;
      padding:9px 12px;
      font-size:12px;
      font-weight:800;
      cursor:pointer;
    }
    .tabBtn.active{
      background:rgba(255,255,255,.10);
      border-color:rgba(255,255,255,.28);
      box-shadow: 0 0 0 2px rgba(0,0,0,.25) inset;
    }

    main{ max-width:1120px; margin:16px auto 28px; padding:0 16px; }

    .card{
      background:var(--card);
      border:1px solid var(--cardBorder);
      border-radius:14px;
      overflow:hidden;
      box-shadow: 0 10px 30px rgba(0,0,0,.5);
    }

    .sectionBar{
      background:#0d1c2f;
      border-bottom:1px solid rgba(255,255,255,.10);
      padding:14px 16px;
      display:flex; justify-content:space-between; align-items:center; gap:12px;
      flex-wrap:wrap;
    }
    .sectionBar .left{ display:flex; align-items:baseline; gap:12px; flex-wrap:wrap; }
    .sectionBar .label{ font-weight:800; font-size:16px; }
    .sectionBar .sub{ color:rgba(255,255,255,.7); font-size:12px; }
    .sectionBar .right{ color:rgba(255,255,255,.8); font-size:12px; white-space:nowrap; display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .refreshBtn{ padding:7px 10px; font-size:11px; }

    .tblHead{
      background:#060607;
      border-top:1px solid rgba(255,255,255,.08);
      border-bottom:1px solid rgba(255,255,255,.08);
      padding:10px 16px;
      color:rgba(255,255,255,.72);
      font-size:11px;
      letter-spacing:.18em;
      text-transform:uppercase;
    }

    .tbl{
      display:grid;
      grid-template-columns: 140px 64px 1fr 240px 140px;
      gap:12px;
      align-items:center;
      padding:0 16px;
    }

    .row{
      border-bottom:1px solid rgba(255,255,255,.06);
      box-shadow: inset 0 -1px 0 var(--greenLine);
      padding:14px 0;
    }
    .row:nth-child(odd){ background:var(--rowA); }
    .row:nth-child(even){ background:var(--rowB); }

    .date{
      font-variant-numeric: tabular-nums;
      color:rgba(255,255,255,.88);
      font-size:13px;
      white-space:nowrap;
    }
    .icon{ font-size:20px; line-height:1; display:flex; align-items:center; justify-content:center; }
    .addr a{ display:block; font-size:14px; font-weight:700; color:var(--link); }
    .addr .typeText{
      margin-top:3px;
      font-size:12px;
      color:rgba(255,255,255,.55);
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
      max-width:100%;
    }

    .mono{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      font-size:12px;
      color:rgba(255,255,255,.85);
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }

    .chip{
      display:inline-flex; align-items:center; justify-content:center;
      padding:6px 10px; border-radius:999px;
      font-size:12px; font-weight:750;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.04);
      color:rgba(255,255,255,.92);
      white-space:nowrap;
    }
    .chip.green{ border-color:rgba(34,197,94,.35); background:rgba(34,197,94,.10); }
    .chip.amber{ border-color:rgba(245,158,11,.35); background:rgba(245,158,11,.10); }
    .chip.slate{ border-color:rgba(148,163,184,.30); background:rgba(148,163,184,.10); }

    /* Weather severity chip colors */
    .chip.sev-moderate { border-color: rgba(34,197,94,.55); background: rgba(34,197,94,.18); }
    .chip.sev-severe   { border-color: rgba(239,68,68,.55); background: rgba(239,68,68,.18); }
    .chip.sev-extreme  { border-color: rgba(168,85,247,.55); background: rgba(168,85,247,.18); }
    .chip.sev-minor    { border-color: rgba(234,179,8,.55);  background: rgba(234,179,8,.18); }
    .chip.sev-unknown  { border-color: rgba(148,163,184,.45); background: rgba(148,163,184,.16); }

    .helper{ padding:10px 16px; color:rgba(255,255,255,.4); font-size:11px; }

    .mapCard{ margin-top:18px; }
    .mapTop{
      display:flex; align-items:center; justify-content:space-between;
      padding:14px 16px;
      background:rgba(255,255,255,.04);
      border-bottom:1px solid rgba(255,255,255,.10);
    }
    .mapTop .label{ font-weight:800; font-size:16px; }

    .btn{
      appearance:none;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.06);
      color:rgba(255,255,255,.92);
      border-radius:10px;
      padding:8px 12px;
      font-size:12px;
      font-weight:750;
      cursor:pointer;
    }
    .btn:hover{ background:rgba(255,255,255,.10); }

    #map_fire, #map_chp, #map_eq, #map_weather, #map_cams, #map_heli { height:360px; background:#111; }

    .tabPanel{ display:none; }
    .tabPanel.active{ display:block; }

    .emojiPin{
      width:34px;height:34px;
      border-radius:999px;
      display:flex;align-items:center;justify-content:center;
      border:2px solid rgba(255,255,255,.85);
      box-shadow: 0 10px 18px rgba(0,0,0,.5);
      font-size:18px;
      background:#1f2937;
    }

    /* ============= FIRE/MEDICAL: emoji centered under date/time ============= */
#tab_fire .tbl.fmTbl{
  grid-template-columns: 160px 1fr 240px 140px;
  align-items: stretch;            /* let the left cell stretch to full row height */
}

#tab_fire .date{
  align-self: stretch;             /* make the date cell fill the row height */
}

#tab_fire .callLeft{
  display: grid;
  grid-template-rows: auto 1fr;    /* time takes what it needs, rest is free space */
  height: 100%;
  justify-items: center;
  text-align: center;
  gap: 0;                          /* remove fixed gap so centering is true */
}

#tab_fire .callWhen{
  font-size: 13px;
  line-height: 1.15;
  opacity: .95;
  margin-bottom: 4px;              /* small breathing room under the time */
}

#tab_fire .callEmoji{
  align-self: center;              /* center emoji within the remaining space */
  font-size: 22px;
  line-height: 1;
}

    /* ============= WEATHER: fix wrapping/stacking ============= */
    #tab_weather .tbl.wxTbl{
      grid-template-columns: 170px 1fr 240px 140px;
      align-items:start;
    }
    #tab_weather .addr .typeText{
      white-space:normal;
      overflow:visible;
      text-overflow:unset;
      word-break:break-word;
    }
    #tab_weather .mono{
      white-space:normal;
      overflow:visible;
      text-overflow:unset;
      word-break:break-word;
    }

    /* CHP table */
    .chpGridHead{
      display:grid;
      grid-template-columns: 160px 220px 1fr 90px 90px;
      gap:10px;
      align-items:center;
      padding:10px 16px;
      color:rgba(255,255,255,.72);
      font-size:11px;
      letter-spacing:.18em;
      text-transform:uppercase;
      border-top:1px solid rgba(255,255,255,.08);
      border-bottom:1px solid rgba(255,255,255,.08);
      background:#060607;
    }
    .chpRow{
      display:grid;
      grid-template-columns: 160px 220px 1fr 90px 90px;
      gap:10px;
      align-items:start;
      padding:14px 16px;
      border-bottom:1px solid rgba(255,255,255,.06);
      box-shadow: inset 0 -1px 0 var(--greenLine);
      cursor:pointer;
    }
    .chpRow:nth-child(odd){ background:var(--rowA); }
    .chpRow:nth-child(even){ background:var(--rowB); }
    .chpTime{ font-variant-numeric: tabular-nums; font-size:13px; color:rgba(255,255,255,.88); }
    .chpType{ font-weight:800; font-size:13px; }
    .chpLoc{ font-size:13px; color:rgba(255,255,255,.86); white-space:pre-wrap; word-break:break-word; }
    .chpMono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace; font-size:12px; color:rgba(255,255,255,.80); }

    /* Earthquakes */
    .magChip{
      display:inline-flex;align-items:center;justify-content:center;
      padding:6px 10px;border-radius:999px;
      font-size:12px;font-weight:900;
      border:1px solid rgba(255,255,255,.16);
      background:rgba(255,255,255,.06);
      color:rgba(255,255,255,.95);
      white-space:nowrap;
    }
    .eqTbl {
      display: grid;
      grid-template-columns: 120px auto 1fr;
      gap: 12px;
      align-items: center;
      padding: 12px 16px;
      border-bottom:1px solid rgba(255,255,255,.06);
      box-shadow: inset 0 -1px 0 var(--greenLine);
      cursor:pointer;
    }
    .eqTbl:nth-child(odd){ background:var(--rowA); }
    .eqTbl:nth-child(even){ background:var(--rowB); }
    .eq-dt{ display:flex; flex-direction:column; font-weight:700; line-height:1.1; }
    .eq-date{ font-size:13px; }
    .eq-time{ font-size:12px; opacity:.8; margin-top:4px; }

    .eqHeader{
      display:grid;
      grid-template-columns: 120px auto 1fr;
      gap: 12px;
      padding: 10px 16px;
      font-size: 11px;
      letter-spacing: .18em;
      text-transform: uppercase;
      opacity: .72;
      background:#060607;
      border-bottom:1px solid rgba(255,255,255,.08);
      border-top:1px solid rgba(255,255,255,.08);
    }

    /* ArcGIS iframe */
    .embed-wrap{
      width:100%;
      height: calc(100vh - 220px);
      border-radius: 16px;
      overflow:hidden;
      border: 1px solid rgba(255,255,255,0.08);
      background: #0b0b0b;
    }
    .embed-wrap iframe{
      width:100%;
      height:100%;
      border:0;
      display:block;
    }

    /* Cameras list */
    .camRow{
      display:grid;
      grid-template-columns: 84px 1fr 140px;
      gap:12px;
      align-items:center;
      padding:12px 16px;
      border-bottom:1px solid rgba(255,255,255,.06);
      box-shadow: inset 0 -1px 0 var(--greenLine);
      cursor:pointer;
    }
    .camRow:nth-child(odd){ background:var(--rowA); }
    .camRow:nth-child(even){ background:var(--rowB); }

    .camThumb{
      width:84px; height:54px;
      border-radius:10px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.04);
      object-fit:cover;
      display:block;
    }
    .camName{ font-weight:900; font-size:14px; }
    .camMeta{ font-size:12px; color:rgba(255,255,255,.65); margin-top:4px; }
    .camRight{ display:flex; justify-content:flex-end; gap:8px; align-items:center; }

    .badgeOnline{
      display:inline-flex; align-items:center; justify-content:center;
      padding:6px 10px; border-radius:999px;
      font-size:12px; font-weight:850;
      border:1px solid rgba(34,197,94,.35);
      background:rgba(34,197,94,.10);
      white-space:nowrap;
    }
    .badgeOffline{
      display:inline-flex; align-items:center; justify-content:center;
      padding:6px 10px; border-radius:999px;
      font-size:12px; font-weight:850;
      border:1px solid rgba(148,163,184,.30);
      background:rgba(148,163,184,.10);
      white-space:nowrap;
    }

    /* Helispots controls + table */
    .controlsRow{
      display:flex;
      gap:10px;
      align-items:center;
      padding:12px 16px;
      border-bottom:1px solid rgba(255,255,255,.08);
      background:rgba(0,0,0,.25);
      flex-wrap:wrap;
    }
    .input, .select{
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.14);
      color:rgba(255,255,255,.92);
      border-radius:10px;
      padding:10px 12px;
      font-size:13px;
      outline:none;
    }
    .input{ flex:1 1 320px; min-width:240px; }
    .select{ width:180px; }

    .heliHead{
      display:grid;
      grid-template-columns: 1fr 160px 220px;
      gap:10px;
      align-items:center;
      padding:10px 16px;
      color:rgba(255,255,255,.72);
      font-size:11px;
      letter-spacing:.18em;
      text-transform:uppercase;
      background:#060607;
      border-bottom:1px solid rgba(255,255,255,.08);
    }
    .heliRow{
      display:grid;
      grid-template-columns: 1fr 160px 220px;
      gap:10px;
      align-items:center;
      padding:12px 16px;
      border-bottom:1px solid rgba(255,255,255,.06);
      box-shadow: inset 0 -1px 0 var(--greenLine);
      cursor:pointer;
    }
    .heliRow:nth-child(odd){ background:var(--rowA); }
    .heliRow:nth-child(even){ background:var(--rowB); }

    .heliName{ font-weight:800; font-size:13px; }
    .heliTypeChip{
      display:inline-flex; align-items:center; justify-content:center;
      padding:6px 10px; border-radius:999px;
      font-size:12px; font-weight:800;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.06);
      color:rgba(255,255,255,.95);
      white-space:nowrap;
      width:max-content;
    }
    .heliTypeChip.helispot{ border-color:rgba(239,68,68,.35); background:rgba(239,68,68,.12); }
    .heliTypeChip.medevac{ border-color:rgba(168,85,247,.35); background:rgba(168,85,247,.12); }
    .heliTypeChip.snorkel{ border-color:rgba(234,179,8,.35); background:rgba(234,179,8,.12); }

    .heliLoc a{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      font-size:12px;
      color:var(--link);
      white-space:nowrap;
    }

    .pager{
      display:flex; gap:8px; align-items:center; justify-content:space-between;
      padding:12px 16px;
      border-top:1px solid rgba(255,255,255,.08);
      background:rgba(255,255,255,.02);
      flex-wrap:wrap;
    }
    .pager .left{ color:rgba(255,255,255,.7); font-size:12px; }
    .pager .right{ display:flex; gap:8px; align-items:center; }
    .pager .pill{
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.06);
      color:rgba(255,255,255,.92);
      border-radius:999px;
      padding:8px 10px;
      font-size:12px;
      font-weight:800;
      cursor:pointer;
    }
    .pager .pill:disabled{ opacity:.45; cursor:not-allowed; }

    /* Mobile */
    .mobileMeta{ display:none; }
    @media (max-width: 760px){
      .tblHead{ display:none; }
      .tbl{ grid-template-columns: 118px 44px 1fr; gap:10px; align-items:start; }
      .addr a{ white-space:normal; overflow:visible; text-overflow:unset; line-height:1.15; }
      .desktopUnits, .desktopStatus{ display:none; }
      .mobileMeta{
        display:flex; flex-wrap:wrap; gap:8px; margin-top:6px; align-items:center;
      }
      .mobileUnits{
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
        font-size:12px; color:rgba(255,255,255,.82);
        white-space:normal;
      }

      #map_fire, #map_chp, #map_eq, #map_weather, #map_cams, #map_heli { height:420px; }

      .chpGridHead{ display:none; }
      .chpRow{
        display:block;
        border-radius:14px;
        margin:12px 16px;
        border:1px solid rgba(255,255,255,.10);
        padding:12px;
      }
      .chpKV{ display:grid; grid-template-columns: 92px 1fr; gap:10px 12px; padding:6px 0; }
      .k{ color:rgba(255,255,255,.55); font-weight:800; letter-spacing:.08em; font-size:11px; text-transform:uppercase; }
      .v{ font-size:13px; color:rgba(255,255,255,.9); }

      .eqHeader{ display:none; }
      .eqTbl{ grid-template-columns: 120px 90px 1fr; }

      .camRow{ grid-template-columns: 84px 1fr; }
      .camRight{ justify-content:flex-start; }

      .heliHead{ display:none; }
      .heliRow{
        grid-template-columns: 1fr;
        gap:8px;
        border-radius:14px;
        margin:10px 12px;
        padding:12px;
        border:1px solid rgba(255,255,255,.10);
      }
      .heliLoc a{ white-space:normal; }

      /* Fire table mobile (date+emoji left, address right) */
      #tab_fire .tbl.fmTbl{ grid-template-columns: 118px 1fr; }

      /* Weather mobile: stack nicely */
      #tab_weather .tbl.wxTbl{ grid-template-columns: 1fr; gap:8px; }
      #tab_weather .date{ white-space:normal; }
    }
  </style>
</head>

<body>
  <header>
    <div class="bar">
      <div class="wrap">
        <div class="title">
          <h1>VC Incident Watch</h1>
          <p>Live Ventura County situational awareness</p>
        </div>
        <div class="statusBox">
          <span class="dot" id="dot"></span>
          <span id="statusText">Idle</span>
          <a class="adminLink" href="/admin.html">Admin</a>
        </div>
      </div>

      <div class="tabsWrap">
        <button class="tabBtn active" data-tab="fire">Fire/Medical</button>
        <button class="tabBtn" data-tab="chp">CHP</button>
        <button class="tabBtn" data-tab="eq">Earthquakes</button>
        <button class="tabBtn" data-tab="weather">Weather Alerts</button>
        <button class="tabBtn" data-tab="arcgis">VC-EOC Map</button>
        <button class="tabBtn" data-tab="cams">Cameras</button>
        <button class="tabBtn" data-tab="heli">Helispots</button>
      </div>
    </div>
  </header>

  <main>
    <!-- ================= FIRE / MEDICAL ================= -->
    <div class="tabPanel active" id="tab_fire">
      <section class="card" aria-label="Active Calls">
        <div class="sectionBar">
          <div class="left">
            <div class="label">Active Calls</div>
            <div class="sub" id="updatedAt_fire">Last updated ‚Äî</div>
          </div>
          <div class="right">
            <span id="activeCount_fire">‚Äî active</span>
          </div>
        </div>

        <div class="tblHead">
          <div class="tbl fmTbl" style="padding:0;">
            <div>DATE/TIME</div>
            <div>ADDRESS</div>
            <div>UNITS</div>
            <div>STATUS</div>
          </div>
        </div>

        <div id="rows_fire"></div>
        <div class="helper">Row tap jumps to map. Address tap opens Google Maps.</div>
      </section>

      <section class="card mapCard" aria-label="Map">
        <div class="mapTop">
          <div class="label">Map</div>
          <button class="btn" id="fitBtn_fire" type="button">Fit Map</button>
        </div>
        <div id="map_fire"></div>
      </section>
    </div>

    <!-- ================= CHP ================= -->
    <div class="tabPanel" id="tab_chp">
      <section class="card" aria-label="CHP Incidents">
        <div class="sectionBar">
          <div class="left">
            <div class="label">CHP (Ventura County)</div>
            <div class="sub" id="updatedAt_chp">Updated ‚Äî</div>
          </div>
          <div class="right" id="activeCount_chp">‚Äî incidents</div>
        </div>

        <div class="chpGridHead">
          <div>TIME</div><div>TYPE</div><div>LOCATION</div><div>LAT</div><div>LON</div>
        </div>

        <div id="rows_chp"></div>
        <div class="helper">Tap a row to zoom on the map.</div>
      </section>

      <section class="card mapCard" aria-label="CHP Map">
        <div class="mapTop">
          <div class="label">Map</div>
          <button class="btn" id="fitBtn_chp" type="button">Fit Map</button>
        </div>
        <div id="map_chp"></div>
      </section>
    </div>

    <!-- ================= EARTHQUAKES ================= -->
    <div class="tabPanel" id="tab_eq">
      <section class="card" aria-label="Earthquakes">
        <div class="sectionBar">
          <div class="left">
            <div class="label">Earthquakes (SoCal ‚Ä¢ Past 24h ‚Ä¢ M2.0+)</div>
            <div class="sub" id="updatedAt_eq">Updated ‚Äî</div>
          </div>
          <div class="right">
            <span id="activeCount_eq">‚Äî events</span>
          </div>
        </div>

        <div class="eqHeader">
          <div>Date / Time</div><div>Magnitude</div><div>Location / Depth</div>
        </div>

        <div id="rows_eq"></div>
        <div class="helper">Tap an event to zoom on the map.</div>
      </section>

      <section class="card mapCard" aria-label="Earthquake Map">
        <div class="mapTop">
          <div class="label">Map</div>
          <button class="btn" id="fitBtn_eq" type="button">Fit Map</button>
        </div>
        <div id="map_eq"></div>
      </section>
    </div>

    <!-- ================= WEATHER ALERTS ================= -->
    <div class="tabPanel" id="tab_weather">
      <section class="card" aria-label="Weather Alerts">
        <div class="sectionBar">
          <div class="left">
            <div class="label">Weather Alerts (NWS)</div>
            <div class="sub" id="updatedAt_weather">Updated ‚Äî</div>
          </div>
          <div class="right" id="activeCount_weather">‚Äî alerts</div>
        </div>

        <div id="rows_weather"></div>
        <div class="helper">Tap an alert to zoom to its polygon.</div>
      </section>

      <section class="card mapCard" aria-label="Weather Map">
        <div class="mapTop">
          <div class="label">Map</div>
          <button class="btn" id="fitBtn_weather" type="button">Fit Map</button>
        </div>
        <div id="map_weather"></div>
      </section>
    </div>

    <!-- ================= VC-EOC MAP (ArcGIS) ================= -->
    <div class="tabPanel" id="tab_arcgis">
      <section class="card" aria-label="VC-EOC Map">
        <div class="sectionBar">
          <div class="left">
            <div class="label">VC-EOC Map</div>
            <div class="sub">Primary map view</div>
          </div>
        </div>

        <div class="embed-wrap">
          <iframe
            title="VC-EOC Map"
            src="https://www.arcgis.com/apps/View/index.html?appid=24d2d88d701b4eaa8e9fe6e5882c8258"
            loading="lazy"
            referrerpolicy="no-referrer-when-downgrade"
            allowfullscreen
          ></iframe>
        </div>

        <div class="helper">Data source: ArcGIS</div>
      </section>
    </div>

    <!-- ================= CAMERAS ================= -->
    <div class="tabPanel" id="tab_cams">
      <section class="card" aria-label="Fire Cameras">
        <div class="sectionBar">
          <div class="left">
            <div class="label">Cameras (Ventura County)</div>
            <div class="sub" id="updatedAt_cams">Updated ‚Äî</div>
          </div>
          <div class="right" id="activeCount_cams">‚Äî cameras</div>
        </div>

        <div id="rows_cams"></div>
        <div class="helper">Tap a row to zoom. ‚ÄúOpen‚Äù launches the camera page in a new tab.</div>
      </section>

      <section class="card mapCard" aria-label="Camera Map">
        <div class="mapTop">
          <div class="label">Map</div>
          <button class="btn" id="fitBtn_cams" type="button">Fit Map</button>
        </div>
        <div id="map_cams"></div>
      </section>
    </div>

    <!-- ================= HELISPOTS ================= -->
    <div class="tabPanel" id="tab_heli">
      <section class="card" aria-label="Helispots">
        <div class="sectionBar">
          <div class="left">
            <div class="label">Helispots</div>
            <div class="sub">Helispots, Medivac LZs, and Snorkel Sites (Ventura County)</div>
          </div>
          <div class="right">
            <span id="heliCount">‚Äî sites</span>
          </div>
        </div>

        <div class="controlsRow">
          <input class="input" id="heliSearch" placeholder="Search (name or number)..." />
          <select class="select" id="heliType">
            <option value="all">Type: All</option>
            <option value="Helispot">Helispot</option>
            <option value="LZ Medivac">LZ Medivac</option>
            <option value="Snorkel Site">Snorkel Site</option>
          </select>
        </div>

        <div class="heliHead">
          <div>Name</div>
          <div>Type</div>
          <div>Location (Lat, Lon)</div>
        </div>

        <div id="rows_heli"></div>

        <div class="pager">
          <div class="left" id="heliPagerText">‚Äî</div>
          <div class="right">
            <button class="pill" id="heliPrev" type="button">Prev</button>
            <button class="pill" id="heliNext" type="button">Next</button>
          </div>
        </div>

        <div class="helper">Tap a row to zoom on the map. Location opens Google Maps.</div>
      </section>

      <section class="card mapCard" aria-label="Helispots Map">
        <div class="mapTop">
          <div class="label">Map</div>
          <button class="btn" id="fitBtn_heli" type="button">Fit Map</button>
        </div>
        <div id="map_heli"></div>
      </section>
    </div>
  </main>

<script>
  // =========================
  // Helpers / Global Status
  // =========================
  function escapeHtml(s){
    return String(s ?? "").replace(/[&<>"']/g, m => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
    }[m]));
  }

  function formatUpdatedLikeVCFD(iso) {
    if (!iso) return "‚Äî";
    const d = new Date(iso);
    if (isNaN(d)) return "‚Äî";
    const m = d.getMonth() + 1;
    const day = d.getDate();
    const yr = String(d.getFullYear()).slice(-2);
    let h = d.getHours();
    const min = String(d.getMinutes()).padStart(2, "0");
    const ampm = h >= 12 ? "pm" : "am";
    h = h % 12 || 12;
    return `${m}/${day}/${yr} ${h}:${min}${ampm}`;
  }

  const dot = document.getElementById("dot");
  const statusText = document.getElementById("statusText");
  function setStatus(state, text){
    dot.classList.remove("ok","wait","err");
    if(state === "ok") dot.classList.add("ok");
    if(state === "wait") dot.classList.add("wait");
    if(state === "err") dot.classList.add("err");
    statusText.textContent = text;
  }

  // =========================
  // Leaflet basemap toggle
  // =========================
  function addBasemapToggle(map){
    const street = L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap contributors'
    });

    const satellite = L.tileLayer(
      "https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",
      { maxZoom: 19, attribution: "Tiles &copy; Esri" }
    );

    street.addTo(map);
    L.control.layers({ "Street": street, "Satellite": satellite }, {}, { position:"topright" }).addTo(map);
  }

  // =========================
  // Marker icons (emoji)
  // =========================
  function emojiFor(typeText){
    const t = (typeText || "").toLowerCase().trim();
    if (t.includes("gas leak") || (t.includes("gas") && t.includes("leak"))) return "‚ö†Ô∏è";
    if(t.includes("medical") || t.includes("ems") || t.includes("ambul")) return "üöë";
    if(t.includes("rescue")) return "üõü";
    if(t.includes("water")) return "üåä";
    if(t.includes("structure")) return "üè†üî•";
    if(t.includes("fire")) return "üî•";
    if(t.includes("vegetation") || t.includes("brush")) return "üåøüî•";
    if(t.includes("haz") || t.includes("hazmat")) return "‚ò£Ô∏è";
    if(t.includes("traffic") || t.includes("tc") || t.includes("collision")) return "üöóüí•";
    if(t.includes("alarm")) return "üîî";
    if(t.includes("investig")) return "üîé";
    if(t.includes("public")) return "üß∞";
    return "üìç";
  }

  function colorForFireMedical(typeText){
    const t = (typeText || "").toLowerCase();
    if(t.includes("gas leak") || (t.includes("gas") && t.includes("leak"))) return "#f59e0b";
    if(t.includes("medical") || t.includes("ems") || t.includes("ambul")) return "#2563eb";
    if(t.includes("traffic") || t.includes("tc") || t.includes("collision")) return "#f97316";
    if(t.includes("fire") || t.includes("structure") || t.includes("vegetation") || t.includes("brush")) return "#ef4444";
    if(t.includes("haz") || t.includes("hazmat")) return "#a855f7";
    if(t.includes("rescue")) return "#22c55e";
    return "#64748b";
  }

  function markerIcon(emoji, colorHex){
    const bg = colorHex || "#64748b";
    return L.divIcon({
      className: "",
      iconSize: [34,34],
      iconAnchor: [17,17],
      popupAnchor: [0,-14],
      html: `<div class="emojiPin" style="background:${bg}">${emoji}</div>`
    });
  }

  function googleMapsLinkFromLatLon(lat, lon){
    const q = encodeURIComponent(`${lat},${lon}`);
    return `https://www.google.com/maps?q=${q}`;
  }

  function googleMapsLinkFromAddress(addr){
    const q = encodeURIComponent(addr || "");
    return `https://www.google.com/maps/search/?api=1&query=${q}`;
  }

  // =========================
  // Tabs + Helispots password
  // =========================
  const tabBtns = document.querySelectorAll(".tabBtn");
  const panels = {
    fire: document.getElementById("tab_fire"),
    chp: document.getElementById("tab_chp"),
    eq: document.getElementById("tab_eq"),
    weather: document.getElementById("tab_weather"),
    arcgis: document.getElementById("tab_arcgis"),
    cams: document.getElementById("tab_cams"),
    heli: document.getElementById("tab_heli"),
  };

  const HELI_AUTH_KEY = "heliAuth";
  const HELI_PASSWORD = "VC2025"; // change whenever you want

  function ensureHeliAuth(){
    if (sessionStorage.getItem(HELI_AUTH_KEY) === "yes") return true;
    const p = prompt("Enter password to access Helispots:");
    if (p === HELI_PASSWORD) {
      sessionStorage.setItem(HELI_AUTH_KEY, "yes");
      return true;
    }
    alert("Access denied");
    return false;
  }

  function setActiveTab(key){
    tabBtns.forEach(b => b.classList.toggle("active", b.dataset.tab === key));
    Object.keys(panels).forEach(k => panels[k].classList.toggle("active", k === key));

    setTimeout(() => {
      if(key==="fire" && map_fire) map_fire.invalidateSize();
      if(key==="chp" && map_chp) map_chp.invalidateSize();
      if(key==="eq" && map_eq) map_eq.invalidateSize();
      if(key==="weather" && map_weather) map_weather.invalidateSize();
      if(key==="cams" && map_cams) map_cams.invalidateSize();
      if(key==="heli" && map_heli) map_heli.invalidateSize();
    }, 50);
  }

  tabBtns.forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const key = btn.dataset.tab;
      if(key === "heli" && !ensureHeliAuth()) return;
      setActiveTab(key);
    });
  });

  // =========================
  // FIRE / MEDICAL
  // =========================
  const FIRE_API_URL = "https://firefeeds.venturacounty.gov/api/incidents";

  let map_fire, layer_fire;
  let fireIncidents = [];
  let fireFetchInProgress = false;

  const rows_fire = document.getElementById("rows_fire");
  const updatedAt_fire = document.getElementById("updatedAt_fire");
  const activeCount_fire = document.getElementById("activeCount_fire");

  function chipFor(statusText){
    const s = (statusText || "").toLowerCase();
    if(s.includes("on scene") || s.includes("onscene")) return `<span class="chip green">On scene</span>`;
    if(s.includes("en route") || s.includes("enroute")) return `<span class="chip amber">En Route</span>`;
    if(!s) return `<span class="chip slate">‚Äî</span>`;
    return `<span class="chip slate">${escapeHtml(statusText)}</span>`;
  }

  function parseResponseDate(s){
    const m = String(s||"").match(/(\d{1,2})\/(\d{1,2})\/(\d{2,4})\s+(\d{1,2}):(\d{2})/);
    if(!m) return 0;
    const mm = parseInt(m[1],10), dd = parseInt(m[2],10), yy = parseInt(m[3],10);
    const hh = parseInt(m[4],10), mi = parseInt(m[5],10);
    const year = yy < 100 ? (2000+yy) : yy;
    return new Date(year, mm-1, dd, hh, mi).getTime() || 0;
  }

  function normalizeTypeLabel(typeText){
    return String(typeText || "").trim();
  }

  function normalizeFire(raw){
    const id = raw?.incidentNumber || raw?.IncidentNumber || raw?.id || crypto.randomUUID();
    const dateStr = raw?.responseDate || raw?.ResponseDate || raw?.date || raw?.Date || "‚Äî";

    const block = raw?.block ? String(raw.block).trim() : "";
    const addr = raw?.address ? String(raw.address).trim() : "";
    const city = raw?.city ? String(raw.city).trim() : "";
    const street = [block, addr].filter(Boolean).join(" ").trim();
    const fullAddress = [street, city].filter(Boolean).join(", ").trim();

    const type = normalizeTypeLabel(raw?.incidentType || raw?.IncidentType || "");
    const status = raw?.status || raw?.Status || "";
    const units = raw?.units || raw?.Units || "";

    const lat = raw?.latitude ?? raw?.Latitude ?? null;
    const lon = raw?.longitude ?? raw?.Longitude ?? null;

    return {
      id, dateStr, type, status, units, fullAddress,
      lat: lat != null ? Number(lat) : null,
      lon: lon != null ? Number(lon) : null
    };
  }

  function initFireMap(){
    map_fire = L.map("map_fire", { zoomControl:true }).setView([34.278, -119.293], 10);
    addBasemapToggle(map_fire);
    layer_fire = L.layerGroup().addTo(map_fire);
    document.getElementById("fitBtn_fire").addEventListener("click", fitFireMap);
  }

  function fitFireMap(){
    const pts = [];
    layer_fire.eachLayer(m => pts.push(m.getLatLng()));
    if(pts.length) map_fire.fitBounds(L.latLngBounds(pts), { padding:[20,20] });
  }

  function updateFireMarkers(){
    layer_fire.clearLayers();
    fireIncidents.forEach(x => {
      if(x.lat == null || x.lon == null) return;

      const marker = L.marker([x.lat, x.lon], {
        incidentId: x.id,
        icon: markerIcon(emojiFor(x.type), colorForFireMedical(x.type))
      });

      marker.bindPopup(`
        <div style="font-family:system-ui;font-size:13px;line-height:1.25">
          <div style="font-weight:900;margin-bottom:6px">${escapeHtml(x.type || "Incident")}</div>
          <div style="color:rgba(0,0,0,.75)">${escapeHtml(x.fullAddress || "")}</div>
          <div style="margin-top:8px;font-size:12px;color:rgba(0,0,0,.75)">
            <div><b>Time:</b> ${escapeHtml(x.dateStr || "‚Äî")}</div>
            <div><b>Units:</b> ${escapeHtml(x.units || "‚Äî")}</div>
            <div><b>Status:</b> ${escapeHtml(x.status || "‚Äî")}</div>
          </div>
        </div>
      `);

      marker.addTo(layer_fire);
    });
  }

  function renderFire(){
    rows_fire.innerHTML = "";
    activeCount_fire.textContent = `${fireIncidents.length} active`;

    fireIncidents.forEach(x => {
      const mapsHref = googleMapsLinkFromAddress(x.fullAddress);
      const statusChip = chipFor(x.status);
      const unitsText = x.units ? escapeHtml(x.units) : `<span style="color:rgba(255,255,255,.35)">‚Äî</span>`;

      const row = document.createElement("div");
      row.className = "row";
      row.innerHTML = `
        <div class="tbl fmTbl">
          <div class="date">
            <div class="callLeft">
              <div class="callWhen">${escapeHtml(x.dateStr)}</div>
              <div class="callEmoji" title="${escapeHtml(x.type)}">${emojiFor(x.type)}</div>
            </div>
          </div>

          <div class="addr">
            <a href="${mapsHref}" target="_blank" rel="noopener noreferrer">${escapeHtml(x.fullAddress || "‚Äî")}</a>
            <div class="typeText">${escapeHtml(x.type || "")}</div>
            <div class="mobileMeta">
              <div class="mobileUnits">${unitsText}</div>
              <div>${statusChip}</div>
            </div>
          </div>

          <div class="desktopUnits mono">${unitsText}</div>
          <div class="desktopStatus">${statusChip}</div>
        </div>
      `;

      row.addEventListener("click", (ev) => {
        const tag = ev.target?.tagName?.toLowerCase?.() || "";
        if(tag === "a" || tag === "button" || tag === "select" || tag === "input") return;

        if(x.lat != null && x.lon != null && map_fire){
          map_fire.setView([x.lat, x.lon], Math.max(map_fire.getZoom(), 12), { animate:true });
          layer_fire.eachLayer(m => { if(m?.options?.incidentId === x.id) m.openPopup(); });
          document.getElementById("map_fire").scrollIntoView({ behavior:"smooth", block:"start" });
        } else {
          document.getElementById("map_fire").scrollIntoView({ behavior:"smooth", block:"start" });
        }
      });

      rows_fire.appendChild(row);
    });
  }

  async function fetchFire(){
    if (fireFetchInProgress) return;
    fireFetchInProgress = true;
    setStatus("wait","Refreshing‚Ä¶");
    try{
      const res = await fetch(FIRE_API_URL, { cache:"no-store" });
      if(!res.ok) throw new Error(`HTTP ${res.status}`);
      const data = await res.json();

      const list = Array.isArray(data) ? data : (Array.isArray(data?.incidents) ? data.incidents : []);
      fireIncidents = list
        .map(normalizeFire)
        .sort((a,b) => parseResponseDate(b.dateStr) - parseResponseDate(a.dateStr));

      updatedAt_fire.textContent = `Last updated ${formatUpdatedLikeVCFD(new Date().toISOString())}`;
      renderFire();
      updateFireMarkers();
      setStatus("ok","Updated");
    }catch(err){
      console.error(err);
      setStatus("err","Error");
      updatedAt_fire.textContent = "Last updated ‚Äî";
      rows_fire.innerHTML = `<div style="padding:16px;color:rgba(255,255,255,.7)">Could not load incidents right now.</div>`;
    } finally {
      fireFetchInProgress = false;
    }
  }

  // =========================
  // CHP (via your /api/incidents)
  // =========================
  let map_chp, layer_chp;
  let chpIncidents = [];

  const rows_chp = document.getElementById("rows_chp");
  const updatedAt_chp = document.getElementById("updatedAt_chp");
  const activeCount_chp = document.getElementById("activeCount_chp");

  function initChpMap(){
    map_chp = L.map("map_chp", { zoomControl:true }).setView([34.278, -119.293], 9);
    addBasemapToggle(map_chp);
    layer_chp = L.layerGroup().addTo(map_chp);
    document.getElementById("fitBtn_chp").addEventListener("click", fitChpMap);
  }

  function fitChpMap(){
    const pts = [];
    layer_chp.eachLayer(m => pts.push(m.getLatLng()));
    if(pts.length) map_chp.fitBounds(L.latLngBounds(pts), { padding:[20,20] });
  }

  function renderChp(){
    rows_chp.innerHTML = "";
    activeCount_chp.textContent = `${chpIncidents.length} incidents`;
    const isMobile = window.matchMedia("(max-width: 760px)").matches;

    chpIncidents.forEach(x=>{
      if(isMobile){
        const card = document.createElement("div");
        card.className = "chpRow";
        card.innerHTML = `
          <div class="chpKV"><div class="k">Time</div><div class="v">${escapeHtml(x.dateStr || "‚Äî")}</div></div>
          <div class="chpKV"><div class="k">Type</div><div class="v">${escapeHtml(x.type || "‚Äî")}</div></div>
          <div class="chpKV"><div class="k">Location</div><div class="v">${escapeHtml(x.location || "‚Äî")}</div></div>
          <div class="chpKV"><div class="k">Lat</div><div class="v chpMono">${x.lat != null ? escapeHtml(x.lat) : "‚Äî"}</div></div>
          <div class="chpKV"><div class="k">Lon</div><div class="v chpMono">${x.lon != null ? escapeHtml(x.lon) : "‚Äî"}</div></div>
        `;
        card.addEventListener("click", ()=>{
          if(x.lat!=null && x.lon!=null){
            map_chp.setView([x.lat, x.lon], Math.max(map_chp.getZoom(), 11), { animate:true });
            document.getElementById("map_chp").scrollIntoView({ behavior:"smooth", block:"start" });
          }
        });
        rows_chp.appendChild(card);
      } else {
        const row = document.createElement("div");
        row.className = "chpRow";
        row.innerHTML = `
          <div class="chpTime">${escapeHtml(x.dateStr || "‚Äî")}</div>
          <div class="chpType">${escapeHtml(x.type || "‚Äî")}</div>
          <div class="chpLoc">${escapeHtml(x.location || "‚Äî")}</div>
          <div class="chpMono">${x.lat != null ? escapeHtml(x.lat) : "‚Äî"}</div>
          <div class="chpMono">${x.lon != null ? escapeHtml(x.lon) : "‚Äî"}</div>
        `;
        row.addEventListener("click", ()=>{
          if(x.lat!=null && x.lon!=null){
            map_chp.setView([x.lat, x.lon], Math.max(map_chp.getZoom(), 11), { animate:true });
            document.getElementById("map_chp").scrollIntoView({ behavior:"smooth", block:"start" });
          }
        });
        rows_chp.appendChild(row);
      }
    });
  }

  function updateChpMarkers(){
    layer_chp.clearLayers();
    chpIncidents.forEach(x=>{
      if(x.lat==null || x.lon==null) return;
      const m = L.marker([x.lat, x.lon], { icon: markerIcon("üöì", "#0ea5e9") })
        .bindPopup(`
          <div style="font-family:system-ui;font-size:13px;line-height:1.25">
            <div style="font-weight:900;margin-bottom:6px">${escapeHtml(x.type || "CHP")}</div>
            <div style="color:rgba(0,0,0,.75);white-space:pre-wrap">${escapeHtml(x.location || "")}</div>
            <div style="margin-top:8px;font-size:12px;color:rgba(0,0,0,.75)">
              <div><b>Time:</b> ${escapeHtml(x.dateStr || "‚Äî")}</div>
              <div><b>Lat/Lon:</b> ${x.lat ?? "‚Äî"}, ${x.lon ?? "‚Äî"}</div>
            </div>
          </div>
        `);
      m.addTo(layer_chp);
    });
  }

  async function fetchChp(){
    setStatus("wait","Refreshing‚Ä¶");
    try{
      const res = await fetch("/api/incidents", { cache:"no-store" });
      if(!res.ok) throw new Error(`HTTP ${res.status}`);
      const data = await res.json();

      const raw = Array.isArray(data?.chp?.incidents) ? data.chp.incidents : [];
      chpIncidents = raw.map((x, i) => {
        const lat = x?.latitude ?? x?.lat ?? null;
        const lon = x?.longitude ?? x?.lon ?? null;
        return {
          id: x?.id ?? `${x?.type || "CHP"}-${i}`,
          dateStr: x?.dateStr ?? x?.dateTime ?? "‚Äî",
          type: x?.type || "CHP",
          location: x?.location || "‚Äî",
          lat: lat != null ? Number(lat) : null,
          lon: lon != null ? Number(lon) : null,
        };
      });

      updatedAt_chp.textContent = data?.updatedAt ? `Updated ${formatUpdatedLikeVCFD(data.updatedAt)}` : "Updated ‚Äî";

      renderChp();
      updateChpMarkers();
      setStatus("ok","Updated");
    }catch(e){
      console.error(e);
      setStatus("err","Error");
      updatedAt_chp.textContent = "Updated ‚Äî";
      rows_chp.innerHTML = `<div style="padding:16px;color:rgba(255,255,255,.7)">Could not load CHP right now.</div>`;
    }
  }

  // =========================
  // EARTHQUAKES (USGS)
  // =========================
  let map_eq, layer_eq;
  let eqEvents = [];

  const rows_eq = document.getElementById("rows_eq");
  const updatedAt_eq = document.getElementById("updatedAt_eq");
  const activeCount_eq = document.getElementById("activeCount_eq");

  const EQ_BBOX = { minLat: 32.0, maxLat: 35.8, minLon: -120.9, maxLon: -114.0 };
  const EQ_MIN_MAG = 2.0;

  function eqInBbox(lat, lon){
    return lat >= EQ_BBOX.minLat && lat <= EQ_BBOX.maxLat &&
           lon >= EQ_BBOX.minLon && lon <= EQ_BBOX.maxLon;
  }

  function initEqMap(){
    map_eq = L.map("map_eq", { zoomControl:true }).setView([34.1, -118.4], 7.5);
    addBasemapToggle(map_eq);
    layer_eq = L.layerGroup().addTo(map_eq);
    document.getElementById("fitBtn_eq").addEventListener("click", fitEqMap);
  }

  function fitEqMap(){
    const pts = [];
    layer_eq.eachLayer(m => { if(m.getLatLng) pts.push(m.getLatLng()); });
    if(pts.length) map_eq.fitBounds(L.latLngBounds(pts), { padding:[20,20] });
  }

  function eqColor(mag){
    const m = Number(mag || 0);
    if(m >= 5.0) return "#ef4444";
    if(m >= 4.0) return "#f97316";
    return "#fbbf24";
  }

  function magChip(mag){
    const c = eqColor(mag);
    return `<span class="magChip" style="background:${c};border-color:rgba(255,255,255,.22)">M ${escapeHtml(mag)}</span>`;
  }

  function updateEqMarkers(){
    layer_eq.clearLayers();
    eqEvents.forEach(ev=>{
      if(ev.lat==null || ev.lon==null) return;
      const m = L.marker([ev.lat, ev.lon], { icon: markerIcon("üìç", "#fbbf24") })
        .bindPopup(`
          <div style="font-family:system-ui;font-size:13px;line-height:1.25">
            <div style="font-weight:900;margin-bottom:6px">M ${escapeHtml(ev.mag ?? "‚Äî")} ‚Äî ${escapeHtml(ev.place || "")}</div>
            <div style="font-size:12px;color:rgba(0,0,0,.75)">
              <div><b>Time:</b> ${escapeHtml(ev.time ? new Date(ev.time).toLocaleString() : "‚Äî")}</div>
              <div><b>Depth:</b> ${escapeHtml(ev.depthKm != null ? (ev.depthKm + " km") : "‚Äî")}</div>
            </div>
          </div>
        `);
      m.addTo(layer_eq);
    });
  }

  function renderEq(){
    rows_eq.innerHTML = "";
    activeCount_eq.textContent = `${eqEvents.length} events`;

    if(!eqEvents.length){
      rows_eq.innerHTML = `<div style="padding:16px;color:rgba(255,255,255,.7)">No SoCal earthquakes M${EQ_MIN_MAG.toFixed(1)}+ found in the past 24 hours.</div>`;
      return;
    }

    eqEvents.forEach(ev=>{
      const dt = ev.time ? new Date(ev.time) : null;
      const dateStr = dt ? dt.toLocaleDateString([], { month:"numeric", day:"numeric", year:"numeric" }) : "‚Äî";
      const timeStr = dt ? dt.toLocaleTimeString([], { hour:"numeric", minute:"2-digit" }) : "‚Äî";

      const row = document.createElement("div");
      row.className = "eqTbl";
      row.innerHTML = `
        <div class="eq-dt">
          <div class="eq-date">${escapeHtml(dateStr)}</div>
          <div class="eq-time">${escapeHtml(timeStr)}</div>
        </div>
        <div>${magChip(ev.mag ?? "‚Äî")}</div>
        <div class="addr">
          <div style="font-weight:900;font-size:14px">${escapeHtml(ev.place || "‚Äî")}</div>
          <div class="typeText">${escapeHtml(ev.depthKm != null ? ("Depth: " + ev.depthKm + " km") : "")}</div>
        </div>
      `;

      row.addEventListener("click", ()=>{
        if(ev.lat!=null && ev.lon!=null){
          map_eq.setView([ev.lat, ev.lon], Math.max(map_eq.getZoom(), 9), { animate:true });
          document.getElementById("map_eq").scrollIntoView({ behavior:"smooth", block:"start" });
        }
      });

      rows_eq.appendChild(row);
    });
  }

  async function fetchEarthquakes(){
    setStatus("wait","Refreshing‚Ä¶");
    try{
      const feed = "https://earthquake.usgs.gov/earthquakes/feed/v1.0/summary/all_day.geojson";
      const res = await fetch(feed, { cache:"no-store" });
      if(!res.ok) throw new Error(`USGS HTTP ${res.status}`);
      const geo = await res.json();

      const feats = Array.isArray(geo?.features) ? geo.features : [];

      eqEvents = feats
        .map(f => {
          const coords = f?.geometry?.coordinates;
          const lon = Array.isArray(coords) ? Number(coords[0]) : null;
          const lat = Array.isArray(coords) ? Number(coords[1]) : null;
          return {
            id: f?.id || "",
            mag: f?.properties?.mag,
            place: f?.properties?.place,
            time: f?.properties?.time,
            lat,
            lon,
            depthKm: Array.isArray(coords) ? Number(coords[2]) : null
          };
        })
        .filter(ev => {
          const magOk = ev.mag != null && Number(ev.mag) >= EQ_MIN_MAG;
          const locOk = ev.lat != null && ev.lon != null;
          const boxOk = locOk ? eqInBbox(ev.lat, ev.lon) : false;
          return magOk && locOk && boxOk;
        })
        .sort((a,b) => (b.time || 0) - (a.time || 0));

      updatedAt_eq.textContent = `Updated ${new Date().toLocaleString()}`;
      renderEq();
      updateEqMarkers();
      setStatus("ok","Updated");
    }catch(e){
      console.error("EQ fetch failed:", e);
      setStatus("err","Error");
      updatedAt_eq.textContent = "Updated ‚Äî";
      rows_eq.innerHTML = `<div style="padding:16px;color:rgba(255,255,255,.7)">Could not load earthquakes right now.</div>`;
    }
  }

  // =========================
  // WEATHER (via your /api/weather)
  // =========================
  let map_weather, layer_weather;
  let wxAlerts = [];

  const rows_weather = document.getElementById("rows_weather");
  const updatedAt_weather = document.getElementById("updatedAt_weather");
  const activeCount_weather = document.getElementById("activeCount_weather");

  function sevKey(sev){
    const s = (sev || "unknown").toLowerCase();
    if (s === "moderate") return "moderate";
    if (s === "severe") return "severe";
    if (s === "extreme") return "extreme";
    if (s === "minor") return "minor";
    return "unknown";
  }

  function sevStyle(sev){
    const k = sevKey(sev);
    if (k === "moderate") return { color:"#22c55e", weight:2, opacity:0.95, fillOpacity:0.18 };
    if (k === "severe")   return { color:"#ef4444", weight:2, opacity:0.95, fillOpacity:0.18 };
    if (k === "extreme")  return { color:"#a855f7", weight:2, opacity:0.95, fillOpacity:0.18 };
    if (k === "minor")    return { color:"#eab308", weight:2, opacity:0.95, fillOpacity:0.16 };
    return { color:"#94a3b8", weight:2, opacity:0.9, fillOpacity:0.14 };
  }

  function initWeatherMap(){
    map_weather = L.map("map_weather", { zoomControl:true }).setView([34.278, -119.293], 8.5);
    addBasemapToggle(map_weather);
    layer_weather = L.layerGroup().addTo(map_weather);
    document.getElementById("fitBtn_weather").addEventListener("click", fitWeatherMap);
  }

  function fitWeatherMap(){
    const bounds = [];
    layer_weather.eachLayer(l => { if(l.getBounds) bounds.push(l.getBounds()); });
    if(bounds.length){
      const b = bounds.reduce((acc,bb)=> acc.extend(bb), bounds[0]);
      map_weather.fitBounds(b, { padding:[20,20] });
    }
  }

  function renderWeather(){
    rows_weather.innerHTML = "";
    activeCount_weather.textContent = `${wxAlerts.length} alerts`;

    if(!wxAlerts.length){
      rows_weather.innerHTML = `<div style="padding:16px;color:rgba(255,255,255,.7)">No active Ventura-related alerts found right now.</div>`;
      return;
    }

    wxAlerts.forEach(a=>{
      const headline = a.headline || a.event || "Alert";
      const area = a.areaDesc || "";
      const sent = a.sent || "";
      const ends = a.ends || a.expires || "";

      const sentDt = sent ? new Date(sent) : null;
      const sentDate = sentDt ? sentDt.toLocaleDateString() : "‚Äî";
      const sentTime = sentDt ? sentDt.toLocaleTimeString([], { hour:"numeric", minute:"2-digit" }) : "‚Äî";

      const endsDt = ends ? new Date(ends) : null;
      const endsStr = endsDt ? endsDt.toLocaleString([], { month:"numeric", day:"numeric", year:"numeric", hour:"numeric", minute:"2-digit" }) : "‚Äî";

      const sev = a.severity || "‚Äî";
      const sevCls = `sev-${sevKey(sev)}`;

      const row = document.createElement("div");
      row.className = "row";
      row.innerHTML = `
        <div class="tbl wxTbl">
          <div class="date">
            <div>${escapeHtml(sentDate)}</div>
            <div style="opacity:.8;margin-top:4px">${escapeHtml(sentTime)}</div>
          </div>
          <div class="addr">
            <div style="font-weight:900;font-size:14px">${escapeHtml(headline)}</div>
            <div class="typeText">${escapeHtml(area)}</div>
          </div>
          <div class="mono">${escapeHtml(endsDt ? ("Ends: " + endsStr) : "‚Äî")}</div>
          <div>
            <span class="chip ${escapeHtml(sevCls)}">${escapeHtml(sev)}</span>
          </div>
        </div>
      `;

      row.addEventListener("click", ()=>{
        if(a._bounds){
          map_weather.fitBounds(a._bounds, { padding:[20,20] });
          document.getElementById("map_weather").scrollIntoView({ behavior:"smooth", block:"start" });
        } else {
          alert("No polygon loaded for this alert yet.");
        }
      });

      rows_weather.appendChild(row);
    });
  }

  function buildWeatherPopup(a){
    return `
      <div style="font-family:system-ui;font-size:13px;line-height:1.25">
        <div style="font-weight:900;margin-bottom:6px">${escapeHtml(a.event || "Weather Alert")}</div>
        <div style="margin-bottom:6px;color:rgba(0,0,0,.75)">${escapeHtml(a.headline || "")}</div>
        <div style="font-size:12px;color:rgba(0,0,0,.75)">
          <div><b>Severity:</b> ${escapeHtml(a.severity || "‚Äî")}</div>
          <div><b>Areas:</b> ${escapeHtml(a.areaDesc || "‚Äî")}</div>
        </div>
      </div>
    `;
  }

  async function updateWeatherMap(){
    layer_weather.clearLayers();

    for (const a of wxAlerts) {
      if (a.geometry) {
        const feature = (a.geometry.type === "Feature" || a.geometry.type === "FeatureCollection")
          ? a.geometry
          : { type: "Feature", properties: {}, geometry: a.geometry };

        const layer = L.geoJSON(feature, { style: sevStyle(a.severity) }).bindPopup(buildWeatherPopup(a));
        layer.addTo(layer_weather);
        try { a._bounds = layer.getBounds(); } catch(_) {}
        continue;
      }

      if (Array.isArray(a.affectedZones) && a.affectedZones.length) {
        const zoneUrls = a.affectedZones.slice(0, 20);
        try {
          const zoneGeo = await Promise.all(
            zoneUrls.map(z =>
              fetch(z, { headers: { "Accept": "application/geo+json" } })
                .then(r => { if (!r.ok) throw new Error("HTTP " + r.status); return r.json(); })
            )
          );

          const combined = {
            type: "FeatureCollection",
            features: zoneGeo.flatMap(z => {
              if (!z) return [];
              if (z.type === "FeatureCollection" && Array.isArray(z.features)) return z.features;
              if (z.type === "Feature") return [z];
              if (z.type && z.coordinates) return [{ type:"Feature", properties:{}, geometry:z }];
              return [];
            })
          };

          if (!combined.features.length) continue;

          const layer = L.geoJSON(combined, { style: sevStyle(a.severity) }).bindPopup(buildWeatherPopup(a));
          layer.addTo(layer_weather);
          try { a._bounds = layer.getBounds(); } catch(_) {}

        } catch (e) {
          console.warn("Weather zone geometry fetch failed:", e);
        }
      }
    }
  }

  async function fetchWeather(){
    setStatus("wait","Refreshing‚Ä¶");
    try{
      const res = await fetch("/api/weather", { cache:"no-store" });
      if(!res.ok) throw new Error(`HTTP ${res.status}`);
      const data = await res.json();

      wxAlerts = Array.isArray(data?.alerts) ? data.alerts : [];
      updatedAt_weather.textContent = data?.updatedAt ? `Updated ${data.updatedAt}` : "Updated ‚Äî";

      renderWeather();
      await updateWeatherMap();
      setStatus("ok","Updated");
    }catch(e){
      console.error(e);
      setStatus("err","Error");
      updatedAt_weather.textContent = "Updated ‚Äî";
      rows_weather.innerHTML = `<div style="padding:16px;color:rgba(255,255,255,.7)">Could not load weather alerts right now.</div>`;
    }
  }

  // =========================
  // CAMERAS (ALERTCalifornia ArcGIS feed)
  // =========================
  const CAM_SERVICE =
    "https://services8.arcgis.com/X84q166Srnyl4JMV/ArcGIS/rest/services/ALERTCalifornia_Camera_Feed/FeatureServer/0/query";

  let map_cams, layer_cams;
  let cams = [];

  const rows_cams = document.getElementById("rows_cams");
  const updatedAt_cams = document.getElementById("updatedAt_cams");
  const activeCount_cams = document.getElementById("activeCount_cams");

  function initCamsMap(){
    map_cams = L.map("map_cams", { zoomControl:true }).setView([34.278, -119.293], 9.8);
    addBasemapToggle(map_cams);
    layer_cams = L.layerGroup().addTo(map_cams);
    document.getElementById("fitBtn_cams").addEventListener("click", fitCamsMap);
  }

  function fitCamsMap(){
    const pts = [];
    layer_cams.eachLayer(m => { if(m.getLatLng) pts.push(m.getLatLng()); });
    if(pts.length) map_cams.fitBounds(L.latLngBounds(pts), { padding:[20,20] });
  }

  function camThumbBusted(url){
    if(!url) return "";
    try{
      const u = new URL(url, window.location.href);
      u.searchParams.set("_", String(Date.now()));
      return u.toString();
    }catch(_){
      return url + (url.includes("?") ? "&" : "?") + "_=" + Date.now();
    }
  }

  function renderCams(){
    rows_cams.innerHTML = "";
    activeCount_cams.textContent = `${cams.length} cameras`;

    if(!cams.length){
      rows_cams.innerHTML = `<div style="padding:16px;color:rgba(255,255,255,.7)">No cameras returned for Ventura County.</div>`;
      return;
    }

    cams.forEach(c => {
      const row = document.createElement("div");
      row.className = "camRow";

      const thumb = c.imageURL ? camThumbBusted(c.imageURL) : "";
      const onlineBadge = c.isOnline ? `<span class="badgeOnline">Online</span>` : `<span class="badgeOffline">Offline</span>`;
      const openHref = c.cameraURL || c.networkURL || "";

      row.innerHTML = `
        <div>
          ${thumb
            ? `<img class="camThumb" src="${thumb}" alt="${escapeHtml(c.cameraName || "Camera")}" loading="lazy" />`
            : `<div class="camThumb" style="display:flex;align-items:center;justify-content:center;">üì∑</div>`
          }
        </div>

        <div>
          <div class="camName">${escapeHtml(c.cameraName || "Unnamed camera")}</div>
          <div class="camMeta">
            ${escapeHtml(c.county || "‚Äî")}
            ${c.lat != null && c.lon != null ? ` ‚Ä¢ ${c.lat.toFixed(4)}, ${c.lon.toFixed(4)}` : ""}
          </div>
        </div>

        <div class="camRight">
          ${onlineBadge}
          ${openHref ? `<a class="btn" href="${openHref}" target="_blank" rel="noopener noreferrer">Open</a>` : ""}
        </div>
      `;

      row.addEventListener("click", (ev) => {
        const tag = ev.target?.tagName?.toLowerCase?.() || "";
        if(tag === "a" || tag === "button") return;

        if(c.lat != null && c.lon != null && map_cams){
          map_cams.setView([c.lat, c.lon], Math.max(map_cams.getZoom(), 12), { animate:true });
          document.getElementById("map_cams").scrollIntoView({ behavior:"smooth", block:"start" });
        }
      });

      rows_cams.appendChild(row);
    });
  }

  function updateCamsMarkers(){
    layer_cams.clearLayers();
    cams.forEach(c => {
      if(c.lat == null || c.lon == null) return;
      const color = c.isOnline ? "#22c55e" : "#64748b";

      const m = L.marker([c.lat, c.lon], { icon: markerIcon("üì∑", color) })
        .bindPopup(`
          <div style="font-family:system-ui;font-size:13px;line-height:1.25">
            <div style="font-weight:900;margin-bottom:6px">${escapeHtml(c.cameraName || "Camera")}</div>
            <div style="font-size:12px;color:rgba(0,0,0,.75)">
              <div><b>Status:</b> ${c.isOnline ? "Online" : "Offline"}</div>
              <div><b>County:</b> ${escapeHtml(c.county || "‚Äî")}</div>
              ${c.cameraURL ? `<div style="margin-top:8px"><a href="${c.cameraURL}" target="_blank" rel="noopener noreferrer">Open camera</a></div>` : ""}
            </div>
          </div>
        `);
      m.addTo(layer_cams);
    });
  }

  async function fetchCams(){
    setStatus("wait","Refreshing‚Ä¶");
    try{
      const where = "UPPER(county)='VENTURA'";
      const outFields = "cameraName,county,isOnline,imageURL,cameraURL,networkURL";
      const url =
        `${CAM_SERVICE}?where=${encodeURIComponent(where)}` +
        `&outFields=${encodeURIComponent(outFields)}` +
        `&returnGeometry=true&outSR=4326&f=geojson&resultRecordCount=2000`;

      const res = await fetch(url, { cache:"no-store" });
      if(!res.ok) throw new Error(`Camera service HTTP ${res.status}`);
      const geo = await res.json();

      const feats = Array.isArray(geo?.features) ? geo.features : [];
      cams = feats.map(f => {
        const p = f?.properties || {};
        const coords = f?.geometry?.coordinates;
        const lon = Array.isArray(coords) ? Number(coords[0]) : null;
        const lat = Array.isArray(coords) ? Number(coords[1]) : null;

        return {
          cameraName: p.cameraName || p.cameraname || p.name || "",
          county: p.county || "",
          isOnline: !!(p.isOnline ?? p.isonline ?? false),
          imageURL: p.imageURL || p.imageUrl || "",
          cameraURL: p.cameraURL || p.cameraUrl || "",
          networkURL: p.networkURL || p.networkUrl || "",
          lat: (lat != null && !Number.isNaN(lat)) ? lat : null,
          lon: (lon != null && !Number.isNaN(lon)) ? lon : null
        };
      }).sort((a,b)=> (a.cameraName || "").localeCompare(b.cameraName || ""));

      updatedAt_cams.textContent = `Updated ${formatUpdatedLikeVCFD(new Date().toISOString())}`;
      renderCams();
      updateCamsMarkers();
      setStatus("ok","Updated");
    }catch(e){
      console.error(e);
      setStatus("err","Error");
      updatedAt_cams.textContent = "Updated ‚Äî";
      rows_cams.innerHTML = `<div style="padding:16px;color:rgba(255,255,255,.7)">Could not load cameras right now.</div>`;
    }
  }

  // =========================
  // HELISPOTS
  // =========================
  let map_heli, layer_heli;
  const rows_heli = document.getElementById("rows_heli");
  const heliCount = document.getElementById("heliCount");
  const heliSearch = document.getElementById("heliSearch");
  const heliType = document.getElementById("heliType");
  const heliPrev = document.getElementById("heliPrev");
  const heliNext = document.getElementById("heliNext");
  const heliPagerText = document.getElementById("heliPagerText");
  const PAGE_SIZE = 15;
  let heliPage = 1;

  const HELI_SITES = [
    { name:"50-A ‚Äî Point Mugu NAS", type:"Helispot", lat:34.11805, lon:-119.107917 },
    { name:"56-A ‚Äî Yerba Buena Rd", type:"Helispot", lat:34.304367, lon:-118.998267 },
    { name:"Solano Verde LZ", type:"LZ Medivac", lat:34.104817, lon:-118.936367 },
    { name:"Shooting Range LZ", type:"LZ Medivac", lat:34.090217, lon:-118.066667 },
    { name:"Mansdorf LZ", type:"LZ Medivac", lat:34.067267, lon:-118.99005 },
    { name:"Station 56 LZ", type:"LZ Medivac", lat:34.050583, lon:-118.954517 },
    { name:"20-A ‚Äî Old Walnut Rd", type:"Helispot", lat:34.4372, lon:-119.177417 },
    { name:"20-B ‚Äî Thomas Aquinas College", type:"Helispot", lat:34.4286, lon:-119.084317 },
    { name:"22-A ‚Äî Lake Casitas", type:"Helispot", lat:34.42185, lon:-119.328583 },
    { name:"22-B ‚Äî Country Drive", type:"Helispot", lat:34.422, lon:-119.284467 },
    { name:"22-C ‚Äî Rose Valley", type:"Helispot", lat:34.54125, lon:-119.185467 },
    { name:"25-A ‚Äî Unocal On-Shore", type:"Helispot", lat:34.355117, lon:-119.421267 },
    { name:"Honor Farm LZ", type:"LZ Medivac", lat:34.427367, lon:-119.295117 },
    { name:"32-A ‚Äî Dos Vientos", type:"Helispot", lat:34.164583, lon:-118.98315 },
    { name:"33-A ‚Äî Sherwood Country Club", type:"Helispot", lat:34.126883, lon:-118.876967 },
    { name:"35-A ‚Äî Rancho Conejo", type:"Helispot", lat:34.207617, lon:-118.929583 },
    { name:"36-A ‚Äî Lambourne Place", type:"Helispot", lat:34.19125, lon:-118.751833 },
    { name:"Green Meadow LZ", type:"LZ Medivac", lat:34.175317, lon:-118.888767 },
    { name:"Sycamore LZ", type:"LZ Medivac", lat:34.146883, lon:-118.964517 },
    { name:"42-A ‚Äî Calleguas", type:"Helispot", lat:34.3057, lon:-118.916567 },
    { name:"44-A ‚Äî Sunset Hills", type:"Helispot", lat:34.22385, lon:-118.81375 },
    { name:"46-A ‚Äî Presidio Drive", type:"Helispot", lat:34.303183, lon:-118.7088 },
    { name:"47-A ‚Äî Station 47", type:"Helispot", lat:34.2879, lon:-118.762533 },
    { name:"East Valley LZ", type:"LZ Medivac", lat:34.24695, lon:-118.83555 },
    { name:"27-A ‚Äî River Street", type:"Helispot", lat:34.3922, lon:-118.937817 },
    { name:"28-A ‚Äî Lake Piru Marina", type:"Helispot", lat:34.4762, lon:-118.761367 },
    { name:"Todd Road LZ", type:"LZ Medivac", lat:34.31145, lon:-119.11395 },

    { name:"16-1 ‚Äî Arcosa Quarry", type:"Snorkel Site", lat:34.76205, lon:-119.043133 },
    { name:"20-1 ‚Äî Black Mountain Ranch", type:"Snorkel Site", lat:34.42145, lon:-119.199567 },
    { name:"21-1 ‚Äî Senior Canyon", type:"Snorkel Site", lat:34.471583, lon:-119.189283 },
    { name:"21-2 ‚Äî Hermitage", type:"Snorkel Site", lat:34.472783, lon:-119.216967 },
    { name:"22-1 ‚Äî Rose Valley", type:"Snorkel Site", lat:34.541283, lon:-119.187417 },
    { name:"22-2 ‚Äî Creek Rd", type:"Snorkel Site", lat:34.428217, lon:-119.355833 },
    { name:"22-3 ‚Äî Hartman Ranch", type:"Snorkel Site", lat:34.603283, lon:-119.393733 },
    { name:"23-1 ‚Äî Lake Casitas", type:"Snorkel Site", lat:34.373233, lon:-119.340867 },
    { name:"26-1 ‚Äî Limoneira", type:"Snorkel Site", lat:34.3345, lon:-119.129017 },
    { name:"27-1 ‚Äî Young Rd", type:"Snorkel Site", lat:34.406217, lon:-118.969283 },
    { name:"27-2 ‚Äî Sycamore & Oak", type:"Snorkel Site", lat:34.4148, lon:-118.9436 },
    { name:"27-3 ‚Äî Elkins Ranch Golf Course", type:"Snorkel Site", lat:34.372867, lon:-118.909483 },
    { name:"28-1 ‚Äî LaVerne Nursery", type:"Snorkel Site", lat:34.410767, lon:-118.801933 },
    { name:"28-2 ‚Äî Lake Piru", type:"Snorkel Site", lat:34.467717, lon:-118.753583 },
    { name:"33-1 ‚Äî Lake Sherwood", type:"Snorkel Site", lat:34.1392, lon:-118.868967 },
    { name:"42-1 ‚Äî Moorpark Country Club", type:"Snorkel Site", lat:34.304533, lon:-118.900517 },
    { name:"42-2 ‚Äî Calleguas Dip Tank", type:"Snorkel Site", lat:34.3057, lon:-118.916567 },
    { name:"44-1 ‚Äî Bard Lake", type:"Snorkel Site", lat:34.237417, lon:-118.822383 },
    { name:"46-1 ‚Äî Simi Hills Golf Course", type:"Snorkel Site", lat:34.298333, lon:-118.694167 },
    { name:"46-2 ‚Äî Lost Canyons Golf Course", type:"Snorkel Site", lat:34.31275, lon:-118.729333 },
    { name:"50-1 ‚Äî Broom Ranch", type:"Snorkel Site", lat:34.147517, lon:-119.042783 },
    { name:"51-1 ‚Äî United Water", type:"Snorkel Site", lat:34.276133, lon:-119.125367 },
    { name:"54-1 ‚Äî Scary Dairy", type:"Snorkel Site", lat:34.1825, lon:-119.025283 },
    { name:"55-1 ‚Äî Milligan Ranch", type:"Snorkel Site", lat:34.278733, lon:-119.059767 },
    { name:"55-2 ‚Äî Downs Ranch", type:"Snorkel Site", lat:34.30165, lon:-119.057867 },
    { name:"75-1 ‚Äî Chatsworth Dip Tank", type:"Snorkel Site", lat:34.2325, lon:-118.641167 },
  ];

  function typeClass(t){
    if(t === "Helispot") return "helispot";
    if(t === "LZ Medivac") return "medevac";
    return "snorkel";
  }
  function typeEmoji(t){
    if(t === "Helispot") return "üöÅ";
    if(t === "LZ Medivac") return "üöë";
    return "ü§ø";
  }
  function typeColor(t){
    if(t === "Helispot") return "#ef4444";
    if(t === "LZ Medivac") return "#a855f7";
    return "#eab308";
  }

  function extractSortableCode(name){
    const s = String(name || "").trim();
    const first = s.split("‚Äî")[0].trim();
    const m = first.match(/^(\d+)\s*[-‚Äì]\s*([A-Za-z0-9]+)$/) || first.match(/^(\d+)-([A-Za-z0-9]+)$/);
    if(!m) return null;
    const major = parseInt(m[1],10);
    const minorRaw = m[2];
    const minorIsNum = /^[0-9]+$/.test(minorRaw);
    const minorNum = minorIsNum ? parseInt(minorRaw,10) : null;
    return { major, minorRaw, minorIsNum, minorNum };
  }

  function heliSort(a,b){
    const ca = extractSortableCode(a.name);
    const cb = extractSortableCode(b.name);
    if(ca && cb){
      if(ca.major !== cb.major) return ca.major - cb.major;
      if(ca.minorIsNum && cb.minorIsNum) return ca.minorNum - cb.minorNum;
      if(ca.minorIsNum && !cb.minorIsNum) return -1;
      if(!ca.minorIsNum && cb.minorIsNum) return 1;
      const ma = ca.minorRaw.toUpperCase();
      const mb = cb.minorRaw.toUpperCase();
      if(ma !== mb) return ma < mb ? -1 : 1;
      return a.name.localeCompare(b.name);
    }
    if(ca && !cb) return -1;
    if(!ca && cb) return 1;
    return a.name.localeCompare(b.name);
  }

  function getHeliFiltered(){
    const q = (heliSearch.value || "").trim().toLowerCase();
    const t = heliType.value;

    return HELI_SITES
      .filter(x => (t === "all" ? true : x.type === t))
      .filter(x => {
        if(!q) return true;
        return (x.name || "").toLowerCase().includes(q) || String(x.lat).includes(q) || String(x.lon).includes(q);
      })
      .slice()
      .sort(heliSort);
  }

  function initHeliMap(){
    map_heli = L.map("map_heli", { zoomControl:true }).setView([34.278, -119.293], 9.5);
    addBasemapToggle(map_heli);
    layer_heli = L.layerGroup().addTo(map_heli);
    document.getElementById("fitBtn_heli").addEventListener("click", fitHeliMap);
  }

  function fitHeliMap(){
    const pts = [];
    layer_heli.eachLayer(m => { if(m.getLatLng) pts.push(m.getLatLng()); });
    if(pts.length) map_heli.fitBounds(L.latLngBounds(pts), { padding:[20,20] });
  }

  function updateHeliMarkers(filteredAll){
    layer_heli.clearLayers();
    (filteredAll || []).forEach(x=>{
      if(x.lat==null || x.lon==null) return;
      const m = L.marker([x.lat, x.lon], {
        siteName: x.name,
        icon: markerIcon(typeEmoji(x.type), typeColor(x.type))
      }).bindPopup(`
        <div style="font-family:system-ui;font-size:13px;line-height:1.25">
          <div style="font-weight:900;margin-bottom:6px">${escapeHtml(x.name)}</div>
          <div style="color:rgba(0,0,0,.75);margin-bottom:6px"><b>Type:</b> ${escapeHtml(x.type)}</div>
          <div style="font-size:12px;color:rgba(0,0,0,.75)">
            <div><b>Lat/Lon:</b> ${escapeHtml(x.lat)}, ${escapeHtml(x.lon)}</div>
            <div style="margin-top:8px">
              <a href="${googleMapsLinkFromLatLon(x.lat, x.lon)}" target="_blank" rel="noopener noreferrer">Open in Google Maps</a>
            </div>
          </div>
        </div>
      `);
      m.addTo(layer_heli);
    });
  }

  function renderHeli(){
    const all = getHeliFiltered();
    heliCount.textContent = `${all.length} sites`;

    const totalPages = Math.max(1, Math.ceil(all.length / PAGE_SIZE));
    heliPage = Math.min(heliPage, totalPages);

    const startIdx = (heliPage - 1) * PAGE_SIZE;
    const pageItems = all.slice(startIdx, startIdx + PAGE_SIZE);

    heliPrev.disabled = heliPage <= 1;
    heliNext.disabled = heliPage >= totalPages;

    heliPagerText.textContent = `Page ${heliPage} of ${totalPages} ‚Ä¢ Showing ${pageItems.length} of ${all.length}`;
    rows_heli.innerHTML = "";

    pageItems.forEach(x=>{
      const mapsHref = googleMapsLinkFromLatLon(x.lat, x.lon);
      const row = document.createElement("div");
      row.className = "heliRow";
      row.innerHTML = `
        <div class="heliName">${escapeHtml(x.name)}</div>
        <div><span class="heliTypeChip ${typeClass(x.type)}">${escapeHtml(x.type)}</span></div>
        <div class="heliLoc"><a href="${mapsHref}" target="_blank" rel="noopener noreferrer">${escapeHtml(x.lat.toFixed(4))}, ${escapeHtml(x.lon.toFixed(4))}</a></div>
      `;

      row.addEventListener("click", (ev)=>{
        const tag = ev.target?.tagName?.toLowerCase?.() || "";
        if(tag === "a" || tag === "button" || tag === "select" || tag === "input") return;

        if(map_heli){
          map_heli.setView([x.lat, x.lon], Math.max(map_heli.getZoom(), 12), { animate:true });
          document.getElementById("map_heli").scrollIntoView({ behavior:"smooth", block:"start" });
        }
      });

      rows_heli.appendChild(row);
    });

    updateHeliMarkers(all);
  }

  heliSearch.addEventListener("input", ()=>{ heliPage = 1; renderHeli(); });
  heliType.addEventListener("change", ()=>{ heliPage = 1; renderHeli(); });
  heliPrev.addEventListener("click", ()=>{ heliPage = Math.max(1, heliPage - 1); renderHeli(); });
  heliNext.addEventListener("click", ()=>{ heliPage = heliPage + 1; renderHeli(); });

  // =========================
  // INIT + FIRST LOAD + REFRESH
  // =========================
  initFireMap();
  initChpMap();
  initEqMap();
  initWeatherMap();
  initCamsMap();
  initHeliMap();

  renderHeli();

  fetchFire();
  fetchChp();
  fetchEarthquakes();
  fetchWeather();
  fetchCams();

  registerPushServiceWorker().then(refreshPushState).catch(() => {});

  setInterval(fetchFire, 60000);
  setInterval(fetchChp, 60000);
  setInterval(fetchEarthquakes, 300000);
  setInterval(fetchWeather, 300000);
  setInterval(fetchCams, 120000);

  setStatus("ok","Updated");
</script>
</body>
</html>
 
