<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>VC Incident Watch</title>

  <!-- Leaflet (no integrity hash to avoid SRI/CSP headaches) -->
  <link rel="preconnect" href="https://unpkg.com" crossorigin>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="anonymous"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin="anonymous"></script>

  <style>
    :root{
      --bg:#000;
      --ink:#f4f4f5;
      --muted:rgba(255,255,255,.7);
      --muted2:rgba(255,255,255,.45);
      --link:#60a5fa;

      --hdr:#8c1111;   /* red header */
      --hdrOutline:#000;

      --card:rgba(255,255,255,.03);
      --cardBorder:rgba(255,255,255,.08);

      --rowA:rgba(255,255,255,.02);
      --rowB:rgba(255,255,255,.04);

      --greenLine:rgba(16,185,129,.35);
      --shadow:rgba(0,0,0,.55);
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background:var(--bg);
      color:var(--ink);
    }
    a{ color:var(--link); text-decoration:none; }
    a:hover{ text-decoration:underline; }

    header{ position:sticky; top:0; z-index:50; background:var(--bg); }
    header .bar{
      background:var(--hdr);
      outline:2px solid var(--hdrOutline);
      box-shadow: 0 6px 18px var(--shadow);
    }
    .wrap{
      max-width:1120px; margin:0 auto; padding:14px 16px;
      display:flex; align-items:center; justify-content:space-between; gap:12px;
    }
    .title{ display:flex; flex-direction:column; gap:2px; }
    .title h1{ margin:0; font-size:18px; font-weight:750; letter-spacing:.2px; }
    .title p{ margin:0; font-size:12px; color:rgba(255,255,255,.82); }

    .statusBox{ display:flex; align-items:center; gap:10px; white-space:nowrap; font-size:12px; }
    .dot{ width:10px;height:10px;border-radius:999px; background:rgba(255,255,255,.35); box-shadow:0 0 0 2px rgba(0,0,0,.25) inset; }
    .dot.ok{ background:#34d399; }
    .dot.wait{ background:#fbbf24; }
    .dot.err{ background:#fb7185; }

    .tabs{
      max-width:1120px;
      margin:0 auto;
      padding:0 16px 12px;
      display:flex;
      gap:10px;
      align-items:center;
    }
    .tabBtn{
      appearance:none;
      border:1px solid rgba(255,255,255,.18);
      background:rgba(0,0,0,.18);
      color:rgba(255,255,255,.92);
      border-radius:999px;
      padding:8px 12px;
      font-size:12px;
      font-weight:800;
      cursor:pointer;
    }
    .tabBtn.active{
      border-color:rgba(255,255,255,.30);
      background:rgba(255,255,255,.08);
    }

    main{ max-width:1120px; margin:16px auto 28px; padding:0 16px; }

    .card{
      background:var(--card);
      border:1px solid var(--cardBorder);
      border-radius:14px;
      overflow:hidden;
      box-shadow: 0 10px 30px rgba(0,0,0,.5);
    }

    /* Active Calls bar */
    .sectionBar{
      background:#0d1c2f;
      border-bottom:1px solid rgba(255,255,255,.10);
      padding:14px 16px;
      display:flex; justify-content:space-between; align-items:center; gap:12px;
    }
    .sectionBar .left{ display:flex; align-items:baseline; gap:12px; flex-wrap:wrap; }
    .sectionBar .label{ font-weight:800; font-size:16px; }
    .sectionBar .sub{ color:rgba(255,255,255,.7); font-size:12px; }
    .sectionBar .right{ color:rgba(255,255,255,.8); font-size:12px; white-space:nowrap; }

    /* table headings (desktop) */
    .tblHead{
      background:#060607;
      border-top:1px solid rgba(255,255,255,.08);
      border-bottom:1px solid rgba(255,255,255,.08);
      padding:10px 16px;
      color:rgba(255,255,255,.72);
      font-size:11px;
      letter-spacing:.18em;
      text-transform:uppercase;
    }

    /* grid (VC) */
    .tbl{
      display:grid;
      grid-template-columns: 140px 64px 1fr 240px 140px; /* date | icon | address | units | status */
      gap:12px;
      align-items:center;
      padding:0 16px;
    }

    /* grid (CHP) */
    .tbl.chp{
      grid-template-columns: 140px 64px 1fr 1fr; /* date | icon | location | details */
    }

    .row{
      border-bottom:1px solid rgba(255,255,255,.06);
      box-shadow: inset 0 -1px 0 var(--greenLine);
      padding:14px 0;
    }
    .row:nth-child(odd){ background:var(--rowA); }
    .row:nth-child(even){ background:var(--rowB); }

    .date{
      font-variant-numeric: tabular-nums;
      color:rgba(255,255,255,.88);
      font-size:13px;
      white-space:nowrap;
    }
    .icon{ font-size:20px; line-height:1; display:flex; align-items:center; justify-content:center; }
    .addr a{ display:block; font-size:14px; font-weight:700; color:var(--link); }
    .addr .typeText{
      margin-top:3px;
      font-size:12px;
      color:rgba(255,255,255,.55);
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
      max-width:100%;
    }

    .mono{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      font-size:12px;
      color:rgba(255,255,255,.85);
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }

    .chip{
      display:inline-flex; align-items:center; justify-content:center;
      padding:6px 10px; border-radius:999px;
      font-size:12px; font-weight:750;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.04);
      color:rgba(255,255,255,.92);
      white-space:nowrap;
    }
    .chip.green{ border-color:rgba(34,197,94,.35); background:rgba(34,197,94,.10); }
    .chip.amber{ border-color:rgba(245,158,11,.35); background:rgba(245,158,11,.10); }
    .chip.slate{ border-color:rgba(148,163,184,.30); background:rgba(148,163,184,.10); }

    .helper{ padding:10px 16px; color:rgba(255,255,255,.4); font-size:11px; }

    /* Map */
    .mapCard{ margin-top:18px; }
    .mapTop{
      display:flex; align-items:center; justify-content:space-between;
      padding:14px 16px;
      background:rgba(255,255,255,.04);
      border-bottom:1px solid rgba(255,255,255,.10);
    }
    .mapTop .label{ font-weight:800; font-size:16px; }
    .btn{
      appearance:none;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.06);
      color:rgba(255,255,255,.92);
      border-radius:10px;
      padding:8px 12px;
      font-size:12px;
      font-weight:750;
      cursor:pointer;
    }
    .btn:hover{ background:rgba(255,255,255,.10); }
    #map{ height:360px; background:#111; }

    /* ===== MOBILE ===== */
    .mobileMeta{ display:none; }
    @media (max-width: 760px){
      .tblHead{ display:none; }

      /* VC */
      .tbl{ grid-template-columns: 118px 44px 1fr; gap:10px; }
      .addr a{ white-space:normal; overflow:visible; text-overflow:unset; line-height:1.15; }
      .desktopUnits, .desktopStatus{ display:none; }
      .mobileMeta{
        display:flex; flex-wrap:wrap; gap:8px; margin-top:6px; align-items:center;
      }
      .mobileUnits{
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
        font-size:12px; color:rgba(255,255,255,.82);
        white-space:normal;
      }

      /* CHP: keep it readable on mobile too */
      .tbl.chp{ grid-template-columns: 118px 44px 1fr; gap:10px; }
      .chpDetailsDesktop{ display:none; }

      #map{ height:420px; }
    }
  </style>
</head>

<body>
  <header>
    <div class="bar">
      <div class="wrap">
        <div class="title">
          <h1>VC Incident Watch</h1>
          <p id="subtitle">Live Ventura County incidents</p>
        </div>
        <div class="statusBox">
          <span class="dot" id="dot"></span>
          <span id="statusText">Idle</span>
        </div>
      </div>

      <div class="tabs">
        <button class="tabBtn active" id="tabVC" type="button">Ventura County</button>
        <button class="tabBtn" id="tabCHP" type="button">CHP (VC)</button>
      </div>
    </div>
  </header>

  <main>
    <section class="card" aria-label="Active Calls">
      <div class="sectionBar">
        <div class="left">
          <div class="label">Active Calls</div>
          <div class="sub" id="updatedAt">Updated ‚Äî</div>
        </div>
        <div class="right" id="activeCount">‚Äî active</div>
      </div>

      <div class="tblHead" id="tblHead"></div>

      <div id="rows"></div>
      <div class="helper">Row tap jumps to map. Address tap opens Google Maps (VC tab only).</div>
    </section>

    <section class="card mapCard" aria-label="Map">
      <div class="mapTop">
        <div class="label">Map</div>
        <button class="btn" id="fitBtn" type="button">Fit Map</button>
      </div>
      <div id="map"></div>
    </section>
  </main>

<script>
  /********************
   * CONFIG
   ********************/
  const VC_API_URL = "https://firefeeds.venturacounty.gov/api/incidents";

  // Your Cloudflare Worker that returns CHP incidents as JSON for VC-ish bounds:
  // (this is the one you got returning JSON successfully)
  const WORKER_BASE = "https://bp037.brallanp.workers.dev";

  // Ventura-ish bounding box (you used this earlier)
  const VC_BOUNDS = { lat1: 33.9, lat2: 34.9, lon1: -119.9, lon2: -118.6 };

  // This assumes your Worker supports /chp?lat1=&lat2=&lon1=&lon2=
  const CHP_API_URL =
    `${WORKER_BASE}/chp?lat1=${encodeURIComponent(VC_BOUNDS.lat1)}&lat2=${encodeURIComponent(VC_BOUNDS.lat2)}&lon1=${encodeURIComponent(VC_BOUNDS.lon1)}&lon2=${encodeURIComponent(VC_BOUNDS.lon2)}`;

  /********************
   * STATE + ELEMENTS
   ********************/
  let mode = "vc"; // "vc" or "chp"
  let map, markersLayer;
  let lastIncidents = [];

  const dot = document.getElementById("dot");
  const statusText = document.getElementById("statusText");
  const rowsEl = document.getElementById("rows");
  const updatedAtEl = document.getElementById("updatedAt");
  const activeCountEl = document.getElementById("activeCount");
  const subtitleEl = document.getElementById("subtitle");
  const tabVC = document.getElementById("tabVC");
  const tabCHP = document.getElementById("tabCHP");
  const tblHeadEl = document.getElementById("tblHead");

  function setStatus(state, text){
    dot.classList.remove("ok","wait","err");
    if(state === "ok") dot.classList.add("ok");
    if(state === "wait") dot.classList.add("wait");
    if(state === "err") dot.classList.add("err");
    statusText.textContent = text;
  }

  function escapeHtml(s){
    return String(s ?? "").replace(/[&<>"']/g, function(m){
      const mapObj = {"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"};
      return mapObj[m];
    });
  }

  /********************
   * NORMALIZERS
   ********************/
  // VC API: address, block, city, incidentType, responseDate, status, units, latitude, longitude
  function normalizeVC(raw){
    const id = raw?.incidentNumber || raw?.IncidentNumber || raw?.id || (crypto?.randomUUID ? crypto.randomUUID() : String(Math.random()));
    const dateStr = raw?.responseDate || raw?.ResponseDate || raw?.date || raw?.Date || "‚Äî";

    const block = raw?.block ? String(raw.block).trim() : "";
    const addr = raw?.address ? String(raw.address).trim() : "";
    const city = raw?.city ? String(raw.city).trim() : "";
    const street = [block, addr].filter(Boolean).join(" ").trim();
    const fullAddress = [street, city].filter(Boolean).join(", ").trim();

    const type = raw?.incidentType || raw?.IncidentType || "";
    const status = raw?.status || raw?.Status || "";
    const units = raw?.units || raw?.Units || "";

    const lat = raw?.latitude ?? raw?.Latitude ?? null;
    const lon = raw?.longitude ?? raw?.Longitude ?? null;

    return {
      id,
      dateStr,
      type,
      status,
      units,
      fullAddress,
      lat: lat != null ? Number(lat) : null,
      lon: lon != null ? Number(lon) : null
    };
  }

  // CHP Worker output: we expect fields similar to:
  // { id, dateStr, type, status, units, fullAddress, latitude, longitude } OR lat/lon
  function normalizeCHP(raw){
    const id = raw?.id || raw?.incidentNumberId || raw?.incidentNumber || (crypto?.randomUUID ? crypto.randomUUID() : String(Math.random()));
    const dateStr = raw?.dateStr || raw?.responseDate || raw?.time || "";
    const type = raw?.type || "CHP Incident";
    const fullAddress = raw?.fullAddress || raw?.desc || raw?.description || raw?.location || "";
    const latVal = raw?.lat ?? raw?.latitude ?? null;
    const lonVal = raw?.lon ?? raw?.longitude ?? null;

    return {
      id,
      dateStr,
      type,
      status: "",
      units: "",
      fullAddress,
      lat: latVal != null ? Number(latVal) : null,
      lon: lonVal != null ? Number(lonVal) : null
    };
  }

  /********************
   * VC HELPERS
   ********************/
  function emojiFor(typeText){
    const t = (typeText || "").toLowerCase();
    if(t.includes("medical") || t.includes("ems") || t.includes("ambul")) return "üöë";
    if(t.includes("rescue")) return "üõü";
    if(t.includes("water")) return "üåä";
    if(t.includes("structure")) return "üè†üî•";
    if(t.includes("fire")) return "üî•";
    if(t.includes("vegetation") || t.includes("brush")) return "üåøüî•";
    if(t.includes("haz") || t.includes("hazmat")) return "‚ò£Ô∏è";
    if(t.includes("traffic") || t.includes("tc") || t.includes("collision")) return "üöóüí•";
    if(t.includes("alarm")) return "üîî";
    if(t.includes("investig")) return "üîé";
    if(t.includes("public")) return "üß∞";
    return "üìç";
  }

  function chipFor(statusText){
    const s = (statusText || "").toLowerCase();
    if(s.includes("on scene") || s.includes("onscene")) return '<span class="chip green">On scene</span>';
    if(s.includes("en route") || s.includes("enroute")) return '<span class="chip amber">En Route</span>';
    if(!s) return '<span class="chip slate">‚Äî</span>';
    return '<span class="chip slate">' + escapeHtml(statusText) + '</span>';
  }

  function googleMapsLink(fullAddress){
    const q = encodeURIComponent(fullAddress || "");
    return "https://www.google.com/maps/search/?api=1&query=" + q;
  }

  function parseResponseDateVC(s){
    // "1/4/26 3:21"
    const m = String(s||"").match(/(\d{1,2})\/(\d{1,2})\/(\d{2,4})\s+(\d{1,2}):(\d{2})/);
    if(!m) return 0;
    const mm = parseInt(m[1],10), dd = parseInt(m[2],10), yy = parseInt(m[3],10);
    const hh = parseInt(m[4],10), mi = parseInt(m[5],10);
    const year = yy < 100 ? (2000+yy) : yy;
    return new Date(year, mm-1, dd, hh, mi).getTime() || 0;
  }

  /********************
   * CHP FORMATTING (your request)
   * - Separate Date/Time column
   * - Separate Location column
   * - No units/status for CHP
   ********************/
  function splitChpText(text){
    const lines = String(text || "").split(/\r?\n/).map(v => v.trim()).filter(Boolean);
    // Many CHP entries look like:
    // "Jan 5 2026 3:19PM 1179-Trfc Collision-1141 Enrt SR154 / Stagecoach Rd ..."
    // We'll pull a "date/time" token from the start if present.
    const first = lines[0] || "";
    const dateMatch = first.match(/^([A-Za-z]{3}\s+\d{1,2}\s+\d{4}\s+\d{1,2}:\d{2}(?:AM|PM))/i);
    const dateTime = dateMatch ? dateMatch[1] : "";

    // Location guess: try after "SR" "/" patterns, otherwise use the remainder of first line
    let location = "";
    let details = "";

    if(first){
      // Remove leading datetime if found
      const firstNoDate = dateTime ? first.slice(dateTime.length).trim() : first;

      // If it has " / " treat that as location chunk
      const slashIdx = firstNoDate.indexOf(" / ");
      if(slashIdx !== -1){
        location = firstNoDate.slice(slashIdx + 3).trim();
      }else{
        // Otherwise try to find "SR" or "US" or "I-" and use from there onward
        const hw = firstNoDate.match(/\b(SR\d+|SR\s*\d+|US\d+|I-\d+|HWY\s*\d+)\b/i);
        if(hw && hw.index != null){
          location = firstNoDate.slice(hw.index).trim();
        }else{
          // fallback: use the whole first line as "location"
          location = firstNoDate.trim();
        }
      }

      // Details: everything else (including first line without date if you want)
      details = lines.slice(1).join(" ‚Ä¢ ");
      if(!details){
        // If no extra lines, use the remainder of first line after date
        details = (dateTime ? first.slice(dateTime.length).trim() : first).trim();
      }
    }

    return {
      dateTime: dateTime || "‚Äî",
      location: location || "‚Äî",
      details: details || ""
    };
  }

  function emojiForChp(typeText){
    // Keep it simple for CHP
    const t = (typeText || "").toLowerCase();
    if(t.includes("collision") || t.includes("hit") || t.includes("trfc") || t.includes("traffic")) return "üöóüí•";
    if(t.includes("hazard") || t.includes("blocking") || t.includes("debris")) return "‚ö†Ô∏è";
    if(t.includes("fire")) return "üî•";
    return "üöî";
  }

  /********************
   * MAP
   ********************/
  function initMap(){
    map = L.map("map", { zoomControl:true }).setView([34.278, -119.293], 10);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    markersLayer = L.layerGroup().addTo(map);
    document.getElementById("fitBtn").addEventListener("click", fitMap);
  }

  function updateMarkers(){
    markersLayer.clearLayers();
    lastIncidents.forEach((x) => {
      if(x.lat == null || x.lon == null) return;

      const marker = L.marker([x.lat, x.lon], { incidentId: x.id });

      if(mode === "chp"){
        const parts = splitChpText(x.fullAddress);
        marker.bindPopup(
          '<div style="font-family:system-ui;font-size:13px;line-height:1.25">' +
            '<div style="font-weight:800;margin-bottom:4px">' + escapeHtml(x.type || "CHP") + '</div>' +
            '<div style="color:rgba(0,0,0,.75)"><b>' + escapeHtml(parts.dateTime) + '</b></div>' +
            '<div style="color:rgba(0,0,0,.75);margin-top:4px">' + escapeHtml(parts.location) + '</div>' +
            (parts.details ? '<div style="margin-top:6px;font-size:12px;color:rgba(0,0,0,.75)">' + escapeHtml(parts.details) + '</div>' : '') +
          '</div>'
        );
      }else{
        marker.bindPopup(
          '<div style="font-family:system-ui;font-size:13px;line-height:1.25">' +
            '<div style="font-weight:800;margin-bottom:4px">' + escapeHtml(x.type || "Incident") + '</div>' +
            '<div style="color:rgba(0,0,0,.75)">' + escapeHtml(x.fullAddress || "") + '</div>' +
            '<div style="margin-top:6px;font-size:12px;color:rgba(0,0,0,.75)">' +
              '<div><b>Time:</b> ' + escapeHtml(x.dateStr || "‚Äî") + '</div>' +
              '<div><b>Units:</b> ' + escapeHtml(x.units || "‚Äî") + '</div>' +
              '<div><b>Status:</b> ' + escapeHtml(x.status || "‚Äî") + '</div>' +
            '</div>' +
          '</div>'
        );
      }

      marker.addTo(markersLayer);
    });
  }

  function fitMap(){
    const pts = [];
    markersLayer.eachLayer((m) => pts.push(m.getLatLng()));
    if(pts.length) map.fitBounds(L.latLngBounds(pts), { padding:[20,20] });
  }

  /********************
   * TABLE HEADS
   ********************/
  function renderTableHead(){
    if(mode === "vc"){
      tblHeadEl.innerHTML =
        '<div class="tbl" style="padding:0;">' +
          '<div>DATE/TIME</div>' +
          '<div>TYPE</div>' +
          '<div>ADDRESS</div>' +
          '<div>UNITS</div>' +
          '<div>STATUS</div>' +
        '</div>';
    }else{
      tblHeadEl.innerHTML =
        '<div class="tbl chp" style="padding:0;">' +
          '<div>DATE/TIME</div>' +
          '<div>TYPE</div>' +
          '<div>LOCATION</div>' +
          '<div class="chpDetailsDesktop">DETAILS</div>' +
        '</div>';
    }
  }

  /********************
   * RENDER
   ********************/
  function render(){
    rowsEl.innerHTML = "";
    activeCountEl.textContent = lastIncidents.length + " active";

    lastIncidents.forEach((x) => {
      const row = document.createElement("div");
      row.className = "row";

      if(mode === "chp"){
        const parts = splitChpText(x.fullAddress);
        row.innerHTML =
          '<div class="tbl chp">' +
            '<div class="date">' + escapeHtml(parts.dateTime) + '</div>' +
            '<div class="icon" title="' + escapeHtml(x.type) + '">' + emojiForChp(x.type) + '</div>' +
            '<div class="addr">' +
              '<div style="font-size:14px;font-weight:800;color:rgba(255,255,255,.92)">' + escapeHtml(parts.location) + '</div>' +
              '<div class="typeText">' + escapeHtml(x.type || "") + '</div>' +
              '<div style="margin-top:6px;font-size:12px;color:rgba(255,255,255,.55);white-space:normal">' + escapeHtml(parts.details) + '</div>' +
            '</div>' +
            '<div class="mono chpDetailsDesktop">' + escapeHtml(parts.details) + '</div>' +
          '</div>';
      }else{
        const mapsHref = googleMapsLink(x.fullAddress);
        const statusChip = chipFor(x.status);
        const unitsText = x.units ? escapeHtml(x.units) : '<span style="color:rgba(255,255,255,.35)">‚Äî</span>';

        row.innerHTML =
          '<div class="tbl">' +
            '<div class="date">' + escapeHtml(x.dateStr) + '</div>' +
            '<div class="icon" title="' + escapeHtml(x.type) + '">' + emojiFor(x.type) + '</div>' +
            '<div class="addr">' +
              '<a href="' + mapsHref + '" target="_blank" rel="noopener noreferrer">' + escapeHtml(x.fullAddress || "‚Äî") + '</a>' +
              '<div class="typeText">' + escapeHtml(x.type || "") + '</div>' +
              '<div class="mobileMeta">' +
                '<div class="mobileUnits">' + unitsText + '</div>' +
                '<div>' + statusChip + '</div>' +
              '</div>' +
            '</div>' +
            '<div class="desktopUnits mono">' + unitsText + '</div>' +
            '<div class="desktopStatus">' + statusChip + '</div>' +
          '</div>';
      }

      row.addEventListener("click", function(ev){
        const tag = ev.target && ev.target.tagName ? ev.target.tagName.toLowerCase() : "";
        if(tag === "a" || tag === "button") return;

        if(x.lat != null && x.lon != null && map){
          map.setView([x.lat, x.lon], Math.max(map.getZoom(), 12), { animate:true });
          markersLayer.eachLayer((m) => {
            if(m && m.options && m.options.incidentId === x.id) m.openPopup();
          });
          document.getElementById("map").scrollIntoView({ behavior:"smooth", block:"start" });
        }else{
          document.getElementById("map").scrollIntoView({ behavior:"smooth", block:"start" });
        }
      });

      rowsEl.appendChild(row);
    });
  }

  /********************
   * FETCH
   ********************/
  async function fetchIncidents(){
    setStatus("wait","Refreshing‚Ä¶");
    try{
      const apiUrl = (mode === "vc") ? VC_API_URL : CHP_API_URL;

      const res = await fetch(apiUrl, { cache:"no-store" });
      if(!res.ok) throw new Error("HTTP " + res.status);

      const data = await res.json();

      if(mode === "vc"){
        lastIncidents = (Array.isArray(data) ? data : [])
          .map(normalizeVC)
          .sort((a,b) => parseResponseDateVC(b.dateStr) - parseResponseDateVC(a.dateStr));

        updatedAtEl.textContent = lastIncidents[0]?.dateStr ? ("Updated " + lastIncidents[0].dateStr) : "Updated ‚Äî";
      }else{
        lastIncidents = (Array.isArray(data) ? data : [])
          .map(normalizeCHP);

        // CHP: no clean date field guaranteed, so just show "Updated now"
        updatedAtEl.textContent = "Updated just now";
      }

      renderTableHead();
      render();
      updateMarkers();
      setStatus("ok","Updated");
    }catch(e){
      console.error(e);
      setStatus("err","Error");
      updatedAtEl.textContent = "Updated ‚Äî";
      rowsEl.innerHTML = '<div style="padding:16px;color:rgba(255,255,255,.7)">Could not load incidents right now.</div>';
    }
  }

  /********************
   * TABS
   ********************/
  function setMode(nextMode){
    mode = nextMode;

    tabVC.classList.toggle("active", mode === "vc");
    tabCHP.classList.toggle("active", mode === "chp");

    if(mode === "vc"){
      subtitleEl.textContent = "Live Ventura County incidents";
      setStatus("wait","Switching‚Ä¶");
      // Map view closer to VC
      if(map) map.setView([34.278, -119.293], 10);
    }else{
      subtitleEl.textContent = "CHP incidents within Ventura County bounds";
      setStatus("wait","Switching‚Ä¶");
      // Keep similar view
      if(map) map.setView([34.278, -119.293], 9);
    }

    // Clear UI quickly then fetch
    rowsEl.innerHTML = "";
    activeCountEl.textContent = "‚Äî active";
    fetchIncidents();
  }

  tabVC.addEventListener("click", function(){ setMode("vc"); });
  tabCHP.addEventListener("click", function(){ setMode("chp"); });

  /********************
   * BOOT
   ********************/
  window.addEventListener("error", function(ev){
    // If JS crashes, show a clear status instead of "Idle"
    setStatus("err","Script error");
  });

  initMap();
  renderTableHead();
  fetchIncidents();
  setInterval(fetchIncidents, 60000);
</script>
</body>
</html>

