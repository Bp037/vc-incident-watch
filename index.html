<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>VC Incident Watch</title>

  <link rel="preconnect" href="https://unpkg.com" crossorigin>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
          integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

  <style>
    :root{
      --bg:#000;
      --panel:#0a0b0f;
      --panel2:#0f1116;
      --rowA:#101010;
      --rowB:#171717;
      --ink:#f4f4f5;
      --muted:rgba(255,255,255,.68);
      --muted2:rgba(255,255,255,.45);
      --link:#60a5fa;

      --hdr:#8c1111;
      --hdrOutline:#000;

      --line:rgba(255,255,255,.09);
      --greenLine:rgba(16,185,129,.35);
      --shadow:rgba(0,0,0,.55);
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background:var(--bg);
      color:var(--ink);
    }

    a{ color:var(--link); text-decoration:none; }
    a:hover{ text-decoration:underline; }

    header{
      position:sticky; top:0; z-index:50;
      background:var(--bg);
    }
    header .bar{
      background:var(--hdr);
      outline:2px solid var(--hdrOutline);
      box-shadow: 0 6px 18px var(--shadow);
    }
    .wrap{
      max-width:1120px;
      margin:0 auto;
      padding:14px 16px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .title{
      display:flex;
      flex-direction:column;
      gap:2px;
    }
    .title h1{
      margin:0;
      font-size:18px;
      font-weight:700;
      letter-spacing:.2px;
    }
    .title p{
      margin:0;
      font-size:12px;
      color:rgba(255,255,255,.8);
    }
    .statusBox{
      display:flex;
      align-items:center;
      gap:10px;
      white-space:nowrap;
      color:rgba(255,255,255,.9);
      font-size:12px;
    }
    .dot{
      width:10px;height:10px;border-radius:999px;
      background:rgba(255,255,255,.35);
      box-shadow:0 0 0 2px rgba(0,0,0,.25) inset;
    }
    .dot.ok{ background:#34d399; }
    .dot.wait{ background:#fbbf24; }
    .dot.err{ background:#fb7185; }

    main{
      max-width:1120px;
      margin:16px auto 28px;
      padding:0 16px;
    }

    .card{
      background:rgba(255,255,255,.03);
      border:1px solid rgba(255,255,255,.08);
      border-radius:14px;
      overflow:hidden;
      box-shadow: 0 10px 30px rgba(0,0,0,.5);
    }

    /* Section header bars (Active Calls / Map) */
    .sectionBar{
      background:#0d1c2f;
      border-bottom:1px solid rgba(255,255,255,.1);
      padding:14px 16px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
    }
    .sectionBar .left{
      display:flex;
      align-items:baseline;
      gap:12px;
      flex-wrap:wrap;
    }
    .sectionBar .label{
      font-weight:700;
      font-size:16px;
    }
    .sectionBar .sub{
      color:rgba(255,255,255,.7);
      font-size:12px;
    }
    .sectionBar .right{
      color:rgba(255,255,255,.8);
      font-size:12px;
      white-space:nowrap;
    }

    /* Table header */
    .tblHead{
      background:#060607;
      border-top:1px solid rgba(255,255,255,.08);
      border-bottom:1px solid rgba(255,255,255,.08);
      padding:10px 16px;
      color:rgba(255,255,255,.72);
      font-size:11px;
      letter-spacing:.18em;
      text-transform:uppercase;
    }

    /* Grid table */
    .tbl{
      display:grid;
      grid-template-columns: 140px 64px 1fr 220px 140px; /* date | icon | address | units | status */
      gap:12px;
      align-items:center;
      padding:0 16px;
    }

    .row{
      border-bottom:1px solid rgba(255,255,255,.06);
      box-shadow: inset 0 -1px 0 var(--greenLine);
      padding:14px 0;
    }
    .row:nth-child(odd){ background:rgba(255,255,255,.02); }
    .row:nth-child(even){ background:rgba(255,255,255,.04); }

    .date{
      font-variant-numeric: tabular-nums;
      color:rgba(255,255,255,.86);
      font-size:13px;
      white-space:nowrap;
    }
    .icon{
      font-size:20px;
      line-height:1;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .addr a{
      display:block;
      font-size:14px;
      font-weight:650;
      color:var(--link);
    }
    .addr .typeText{
      margin-top:3px;
      font-size:12px;
      color:rgba(255,255,255,.55);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width:100%;
    }
    .mono{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size:12px;
      color:rgba(255,255,255,.85);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .chip{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding:6px 10px;
      border-radius:999px;
      font-size:12px;
      font-weight:650;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.04);
      color:rgba(255,255,255,.9);
      white-space:nowrap;
    }
    .chip.green{ border-color:rgba(34,197,94,.35); background:rgba(34,197,94,.10); }
    .chip.amber{ border-color:rgba(245,158,11,.35); background:rgba(245,158,11,.10); }
    .chip.slate{ border-color:rgba(148,163,184,.30); background:rgba(148,163,184,.10); }

    .helper{
      padding:10px 16px;
      color:rgba(255,255,255,.4);
      font-size:11px;
    }

    /* Map card */
    .mapCard{ margin-top:18px; }
    #map{
      height:360px;
      background:#111;
    }
    .mapTop{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:14px 16px;
      background:var(--panel2);
      border-bottom:1px solid rgba(255,255,255,.10);
    }
    .mapTop .label{
      font-weight:700;
      font-size:16px;
    }
    .btn{
      appearance:none;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.06);
      color:rgba(255,255,255,.92);
      border-radius:10px;
      padding:8px 12px;
      font-size:12px;
      font-weight:650;
      cursor:pointer;
    }
    .btn:hover{ background:rgba(255,255,255,.10); }

    /* ===== MOBILE ===== */
    .mobileMeta{ display:none; }

    @media (max-width: 760px){
      .wrap{ padding:12px 14px; }
      .title h1{ font-size:16px; }
      .title p{ font-size:11px; }

      /* Hide table column header on mobile */
      .tblHead{ display:none; }

      /* Collapse grid so nothing goes off-screen */
      .tbl{
        grid-template-columns: 118px 44px 1fr; /* date | icon | main */
        gap:10px;
      }

      /* Show address wrapping on mobile */
      .addr a{
        white-space:normal;
        overflow:visible;
        text-overflow:unset;
        line-height:1.15;
      }

      /* Put Units + Status under the address */
      .desktopUnits, .desktopStatus{ display:none; }
      .mobileMeta{
        display:flex;
        flex-wrap:wrap;
        gap:8px;
        margin-top:6px;
        align-items:center;
      }
      .mobileUnits{
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
        font-size:12px;
        color:rgba(255,255,255,.80);
        white-space:normal;
        overflow:visible;
      }

      #map{ height:420px; }
    }
  </style>
</head>

<body>
  <header>
    <div class="bar">
      <div class="wrap">
        <div class="title">
          <h1>VC Incident Watch</h1>
          <p>Live Ventura County incidents</p>
        </div>

        <div class="statusBox">
          <span class="dot" id="dot"></span>
          <span id="statusText">Idle</span>
        </div>
      </div>
    </div>
  </header>

  <main>
    <section class="card" aria-label="Active Calls">
      <div class="sectionBar">
        <div class="left">
          <div class="label">Active Calls</div>
          <div class="sub" id="updatedAt">Updated ‚Äî</div>
        </div>
        <div class="right" id="activeCount">‚Äî active</div>
      </div>

      <div class="tblHead">
        <div class="tbl" style="padding:0;">
          <div>DATE/TIME</div>
          <div>TYPE</div>
          <div>ADDRESS</div>
          <div>UNITS</div>
          <div>STATUS</div>
        </div>
      </div>

      <div id="rows"></div>

      <div class="helper">Row tap jumps to map. Address tap opens Google Maps.</div>
    </section>

    <section class="card mapCard" aria-label="Map">
      <div class="mapTop">
        <div class="label">Map</div>
        <button class="btn" id="fitBtn" type="button">Fit Map</button>
      </div>
      <div id="map"></div>
    </section>
  </main>

<script>
  const API_URL = "https://firefeeds.venturacounty.gov/api/incidents";

  // --- State
  let map, markersLayer;
  let lastIncidents = [];
  const dot = document.getElementById("dot");
  const statusText = document.getElementById("statusText");
  const rowsEl = document.getElementById("rows");
  const updatedAtEl = document.getElementById("updatedAt");
  const activeCountEl = document.getElementById("activeCount");

  function setStatus(state, text){
    dot.classList.remove("ok","wait","err");
    if(state === "ok") dot.classList.add("ok");
    if(state === "wait") dot.classList.add("wait");
    if(state === "err") dot.classList.add("err");
    statusText.textContent = text;
  }

  function escapeHtml(s){
    return String(s ?? "").replace(/[&<>"']/g, m => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
    }[m]));
  }

  function normalizeIncident(raw){
    // API fields can vary; we normalize to what we need.
    const id = raw?.IncidentId ?? raw?.id ?? raw?.IncidentNumber ?? raw?.IncidentNo ?? raw?.IncidentID ?? crypto.randomUUID();

    const dt = raw?.DateTime ?? raw?.dateTime ?? raw?.Date ?? raw?.date ?? raw?.Created ?? raw?.created;
    const dateStr = raw?.DisplayDateTime ?? raw?.displayDateTime ?? raw?.Timestamp ?? raw?.timestamp ?? dt;

    const address = raw?.Address ?? raw?.address ?? raw?.Location ?? raw?.location ?? "";
    const city = raw?.City ?? raw?.city ?? "";
    const fullAddress = [address, city].filter(Boolean).join(", ").trim();

    const status = raw?.Status ?? raw?.status ?? raw?.UnitStatus ?? raw?.unitStatus ?? "";
    const units = raw?.Units ?? raw?.units ?? raw?.Unit ?? raw?.unit ?? "";

    const type = raw?.Type ?? raw?.type ?? raw?.IncidentType ?? raw?.incidentType ?? raw?.CallType ?? raw?.callType ?? "";
    const subtype = raw?.SubType ?? raw?.subType ?? raw?.Description ?? raw?.description ?? "";

    const lat = raw?.Latitude ?? raw?.latitude ?? raw?.Lat ?? raw?.lat ?? null;
    const lon = raw?.Longitude ?? raw?.longitude ?? raw?.Lon ?? raw?.lon ?? raw?.Lng ?? raw?.lng ?? null;

    return { id, dateStr, type, subtype, fullAddress, address, city, status, units, lat, lon, raw };
  }

  function emojiFor(typeText){
    const t = (typeText || "").toLowerCase();

    if(t.includes("medical") || t.includes("ems") || t.includes("ambul")) return "üöë";
    if(t.includes("rescue")) return "üõü";
    if(t.includes("water")) return "üåä";
    if(t.includes("structure")) return "üè†üî•";
    if(t.includes("fire")) return "üî•";
    if(t.includes("vegetation") || t.includes("brush")) return "üåøüî•";
    if(t.includes("haz") || t.includes("hazmat")) return "‚ò£Ô∏è";
    if(t.includes("traffic") || t.includes("tc") || t.includes("collision")) return "üöóüí•";
    if(t.includes("alarm")) return "üîî";
    if(t.includes("investig")) return "üîé";
    if(t.includes("public")) return "üß∞";
    return "üìç";
  }

  function chipFor(statusText){
    const s = (statusText || "").toLowerCase();
    if(s.includes("on scene") || s.includes("onscene")) return `<span class="chip green">On scene</span>`;
    if(s.includes("en route") || s.includes("enroute")) return `<span class="chip amber">En Route</span>`;
    if(!s) return `<span class="chip slate">‚Äî</span>`;
    return `<span class="chip slate">${escapeHtml(statusText)}</span>`;
  }

  function googleMapsLink(fullAddress){
    const q = encodeURIComponent(fullAddress || "");
    return `https://www.google.com/maps/search/?api=1&query=${q}`;
  }

  function render(){
    rowsEl.innerHTML = "";
    const incidents = lastIncidents;

    activeCountEl.textContent = `${incidents.length} active`;

    incidents.forEach((x, idx) => {
      const e = emojiFor(x.type || x.subtype);
      const mapsHref = googleMapsLink(x.fullAddress || x.address || "");

      const statusChip = chipFor(x.status);
      const unitsText = x.units ? escapeHtml(String(x.units)) : `<span style="color:rgba(255,255,255,.35)">‚Äî</span>`;

      const row = document.createElement("div");
      row.className = "row";
      row.innerHTML = `
        <div class="tbl">
          <div class="date">${escapeHtml(x.dateStr || "‚Äî")}</div>

          <div class="icon" title="${escapeHtml(x.type || "")}">${e}</div>

          <div class="addr">
            <a href="${mapsHref}" target="_blank" rel="noopener noreferrer">${escapeHtml(x.fullAddress || x.address || "‚Äî")}</a>
            <div class="typeText">${escapeHtml(x.subtype || x.type || "")}</div>

            <div class="mobileMeta">
              <div class="mobileUnits">${unitsText}</div>
              <div>${statusChip}</div>
            </div>
          </div>

          <div class="desktopUnits mono">${unitsText}</div>
          <div class="desktopStatus">${statusChip}</div>
        </div>
      `;

      // Row click: pan map (but don't hijack link clicks)
      row.addEventListener("click", (ev) => {
        const tag = (ev.target && ev.target.tagName) ? ev.target.tagName.toLowerCase() : "";
        if(tag === "a" || tag === "button") return;

        if(x.lat != null && x.lon != null && map){
          map.setView([x.lat, x.lon], Math.max(map.getZoom(), 12), { animate:true });
          // find marker and open popup
          markersLayer.eachLayer((m) => {
            if(m?.options?.incidentId === x.id) m.openPopup();
          });
          document.getElementById("map").scrollIntoView({ behavior:"smooth", block:"start" });
        }else{
          document.getElementById("map").scrollIntoView({ behavior:"smooth", block:"start" });
        }
      });

      rowsEl.appendChild(row);
    });
  }

  function initMap(){
    map = L.map("map", { zoomControl:true }).setView([34.278, -119.293], 10);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    markersLayer = L.layerGroup().addTo(map);

    document.getElementById("fitBtn").addEventListener("click", fitMap);
  }

  function fitMap(){
    if(!map || !markersLayer) return;
    const bounds = [];
    markersLayer.eachLayer((m) => {
      if(m.getLatLng) bounds.push(m.getLatLng());
    });
    if(bounds.length){
      map.fitBounds(L.latLngBounds(bounds), { padding:[20,20] });
    }
  }

  function updateMarkers(){
    markersLayer.clearLayers();
    lastIncidents.forEach((x) => {
      if(x.lat == null || x.lon == null) return;
      const marker = L.marker([x.lat, x.lon], { incidentId: x.id });
      const popup = `
        <div style="font-family:system-ui; font-size:13px; line-height:1.25">
          <div style="font-weight:700; margin-bottom:4px">${escapeHtml(x.subtype || x.type || "Incident")}</div>
          <div style="color:rgba(0,0,0,.75)">${escapeHtml(x.fullAddress || "")}</div>
          <div style="margin-top:6px; font-size:12px; color:rgba(0,0,0,.75)">
            <div><b>Time:</b> ${escapeHtml(x.dateStr || "‚Äî")}</div>
            <div><b>Units:</b> ${escapeHtml(String(x.units || "‚Äî"))}</div>
            <div><b>Status:</b> ${escapeHtml(String(x.status || "‚Äî"))}</div>
          </div>
        </div>
      `;
      marker.bindPopup(popup);
      marker.addTo(markersLayer);
    });
  }

  function computeUpdatedAt(list){
    // If API provides a single updated time, use it; else use max of dateStr.
    // We'll just display the first item time if sorted desc.
    const first = list[0];
    if(first?.dateStr) return first.dateStr;
    return "‚Äî";
  }

  function sortDescByDateStr(list){
    // Date strings look like "1/4/26 3:42". We'll parse loosely.
    const parse = (s) => {
      if(!s) return 0;
      // Try MM/DD/YY HH:MM
      const m = String(s).match(/(\d{1,2})\/(\d{1,2})\/(\d{2,4})\s+(\d{1,2}):(\d{2})/);
      if(!m) return 0;
      const mm = parseInt(m[1],10), dd = parseInt(m[2],10), yy = parseInt(m[3],10);
      const hh = parseInt(m[4],10), mi = parseInt(m[5],10);
      const year = yy < 100 ? (2000+yy) : yy;
      return new Date(year, mm-1, dd, hh, mi).getTime() || 0;
    };
    return list.slice().sort((a,b) => parse(b.dateStr) - parse(a.dateStr));
  }

  async function fetchIncidents(){
    setStatus("wait","Refreshing‚Ä¶");
    try{
      const res = await fetch(API_URL, { cache:"no-store" });
      if(!res.ok) throw new Error(`HTTP ${res.status}`);
      const data = await res.json();

      const rawList = Array.isArray(data) ? data : (data?.Incidents || data?.incidents || []);
      const normalized = rawList.map(normalizeIncident);

      // Sort newest first (best effort)
      lastIncidents = sortDescByDateStr(normalized);

      const updated = computeUpdatedAt(lastIncidents);
      updatedAtEl.textContent = `Updated ${updated}`;

      render();
      updateMarkers();
      setStatus("ok","Updated");
    }catch(err){
      console.error(err);
      setStatus("err","Error");
      updatedAtEl.textContent = "Updated ‚Äî";
      rowsEl.innerHTML = `<div style="padding:16px; color:rgba(255,255,255,.7)">Could not load incidents right now.</div>`;
    }
  }

  // Init
  initMap();
  fetchIncidents();
  // refresh every 60s
  setInterval(fetchIncidents, 60000);
</script>
</body>
</html>
