<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>VC Incident Watch</title>

  <script src="https://cdn.tailwindcss.com"></script>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

  <style>
    body { background:#000; }

    .card { border: 1px solid rgba(255,255,255,.08); }
    .mono { font-variant-numeric: tabular-nums; }
    .truncate { overflow:hidden; white-space:nowrap; text-overflow:ellipsis; }

    .tbl{
      display:grid;
      grid-template-columns: 130px 54px 1fr 240px 140px; /* Date | Type | Address | Units | Status */
      gap: 12px;
      align-items:center;
    }

    .row-a { background:#0b0b0b; }
    .row-b { background:#141414; }
    .row-a:hover, .row-b:hover { background:#1b1b1b; }

    /* New-call highlight (pulse once) */
    .new-call {
      animation: newCallPulse 2.0s ease-out 1;
      outline: 1px solid rgba(16,185,129,.35); /* subtle emerald */
      outline-offset: -1px;
    }
    @keyframes newCallPulse {
      0%   { box-shadow: 0 0 0 0 rgba(16,185,129,.35); }
      40%  { box-shadow: 0 0 0 10px rgba(16,185,129,0); }
      100% { box-shadow: 0 0 0 0 rgba(16,185,129,0); }
    }

    @media (max-width: 900px){
      .tbl{ grid-template-columns: 130px 54px 1fr; }
      .col-units, .col-status { display:none; }
    }

    #map { border-top: 1px solid rgba(255,255,255,.08); }

    /* Status chip */
    .chip{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding: 6px 10px;
      border-radius: 999px;
      font-size: 12px;
      line-height: 1;
      border: 1px solid rgba(255,255,255,.10);
      white-space: nowrap;
    }
  </style>
</head>

<body class="text-zinc-100">
  <header class="sticky top-0 z-10 bg-black">
  <div class="bg-[#8c1111] outline outline-2 outline-black shadow-[0_4px_12px_rgba(0,0,0,0.5)]">


      <div class="max-w-6xl mx-auto px-4 py-4 flex items-center justify-between">
        <div>
          <h1 class="text-white text-lg sm:text-xl font-semibold tracking-tight">VC Incident Watch</h1>
          <p class="text-white/80 text-xs sm:text-sm">Live Ventura County incidents</p>
        </div>

        <div class="flex items-center gap-2">
          <span id="statusDot" class="inline-block w-2.5 h-2.5 rounded-full bg-white/40"></span>
          <span id="statusText" class="text-white/90 text-xs sm:text-sm mono">Idle</span>
        </div>
      </div>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 py-6 space-y-6">

    <section class="rounded-2xl overflow-hidden card">
<div class="px-4 sm:px-5 py-4 bg-[#0f243d] border-b border-white/10 flex items-center justify-between">

        <div class="flex items-center gap-3">
          <h2 class="font-semibold text-zinc-100">Active Calls</h2>
          <span id="lastUpdated" class="text-xs text-zinc-400 mono"></span>
        </div>
        <div id="countText" class="text-sm text-zinc-300 mono">0 active</div>
      </div>

      <div class="px-4 sm:px-5 py-2 bg-black border-y border-white/10">
        <div class="tbl text-[11px] tracking-[.18em] uppercase text-zinc-300">
          <div>Date/Time</div>
          <div>Type</div>
          <div>Address</div>
          <div class="col-units">Units</div>
          <div class="col-status">Status</div>
        </div>
      </div>

      <div id="list"></div>

      <div id="empty" class="px-6 py-10 text-center text-zinc-400 hidden">
        No incidents available.
      </div>

      <div class="px-4 sm:px-5 py-3 bg-black text-xs text-zinc-500 border-t border-white/10">
        Row click jumps to map. Address click opens Google Maps.
      </div>
    </section>

    <section class="rounded-2xl overflow-hidden card">
      <div class="px-4 sm:px-5 py-4 bg-black flex items-center justify-between">
        <h2 class="font-semibold text-zinc-100">Map</h2>
        <button id="fitBtn" class="text-sm rounded-xl px-3 py-2 bg-zinc-900 border border-white/10 hover:bg-zinc-800">
          Fit Map
        </button>
      </div>
      <div id="map" style="height: 340px;"></div>
    </section>

  </main>

<script>
/** CONFIG */
const FIRE_API_URL = "https://firefeeds.venturacounty.gov/api/incidents";
const REFRESH_MS = 60_000;
const DEFAULT_VIEW = { lat: 34.280, lng: -119.295, zoom: 10 };

/** EMOJIS */
const TYPE_EMOJI = {
  "Medical": "ðŸš‘",
  "Medical High": "ðŸš‘",
  "Medical High Plus": "ðŸš‘",
  "Medical No Code": "ðŸš‘",
  "EMS": "ðŸš‘",
  "Rescue": "ðŸ›Ÿ",
  "Water Rescue": "ðŸŒŠðŸ›Ÿ",
  "Fire": "ðŸ”¥",
  "Structure Fire": "ðŸ ðŸ”¥",
  "Structure": "ðŸ ðŸ”¥",
  "Brush": "ðŸŒ¿ðŸ”¥",
  "Vegetation": "ðŸŒ¿ðŸ”¥",
  "Alarm": "ðŸ””",
  "Traffic Collision": "ðŸš—ðŸ’¥",
  "TC": "ðŸš—ðŸ’¥",
  "Hazard Investigation": "â˜£ï¸",
  "Hazmat": "â˜£ï¸",
  "Investigation": "ðŸ”Ž",
  "Public Assist": "ðŸ§°",
  "Info Log": "ðŸ“",
  "Other": "ðŸ“"
};
const DEFAULT_EMOJI = "ðŸ“";

const $ = (id) => document.getElementById(id);
let allIncidents = [];
let map, markersLayer;
let markerById = new Map();

/** NEW CALL TRACKING */
let prevIds = new Set();         // previous incident IDs
let newIds = new Set();          // newly detected IDs (for highlight)
let lastUpdatedLabel = "";       // display string

init();

function init() {
  initMap();
  $("fitBtn").addEventListener("click", fitMapToMarkers);
  refreshAll();
  setInterval(refreshAll, REFRESH_MS);
}

function initMap() {
  map = L.map("map", { zoomControl: true }).setView([DEFAULT_VIEW.lat, DEFAULT_VIEW.lng], DEFAULT_VIEW.zoom);
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    maxZoom: 19,
    attribution: "&copy; OpenStreetMap contributors"
  }).addTo(map);
  markersLayer = L.layerGroup().addTo(map);
}

async function refreshAll() {
  setStatus("loading", "Refreshingâ€¦");
  try {
    const res = await fetch(FIRE_API_URL, { cache: "no-store" });
    if (!res.ok) throw new Error(`Feed failed: ${res.status}`);
    const json = await res.json();

    const normalized = normalizeFireFeeds(json);
    normalized.sort((a,b) => (b.sortTime ?? 0) - (a.sortTime ?? 0));

    // detect new IDs
    const currentIds = new Set(normalized.map(x => x.id));
    newIds = new Set();
    for (const id of currentIds) {
      if (!prevIds.has(id)) newIds.add(id);
    }
    prevIds = currentIds;

    allIncidents = normalized;

    // "Last Updated" label â€” use newest call time if available
    lastUpdatedLabel = computeLastUpdatedLabel(allIncidents);
    $("lastUpdated").textContent = lastUpdatedLabel ? `Updated ${lastUpdatedLabel}` : "";

    render(allIncidents);

    // clear highlight after 2.2s so rows don't keep pulsing
    if (newIds.size) {
      setTimeout(() => { newIds = new Set(); }, 2200);
    }

    setStatus("ok", "Updated");
  } catch (e) {
    console.error(e);
    allIncidents = [];
    render(allIncidents);
    setStatus("error", "Feed error");
  }
}

/** FireFeeds normalization (correct fields) */
function normalizeFireFeeds(items) {
  const arr = Array.isArray(items) ? items : [];
  return arr.map((x, i) => {
    const dateStr = (x.responseDate ?? "").toString().trim();
    const type = (x.incidentType ?? "Other").toString().trim();
    const units = (x.units ?? "").toString().trim();
    const status = (x.status ?? "").toString().trim();

    const block = (x.block ?? "").toString().trim();
    const street = (x.address ?? "").toString().trim();
    const city = (x.city ?? "").toString().trim();

    const streetFull = [block, street].filter(Boolean).join(" ").trim();
    const locationText = [streetFull, city].filter(Boolean).join(", ").trim() || "View location";

    const lat = numOrNull(x.latitude);
    const lng = numOrNull(x.longitude);

    // stable id (incidentNumber exists in this feed)
    const id = String(x.incidentNumber ?? `${type}-${locationText}-${i}`);

    return {
      id,
      dateStr,
      sortTime: tryParseTime(dateStr),
      type,
      emoji: emojiForType(type),
      locationText,
      units,
      status,
      lat,
      lng,
      raw: x
    };
  });
}

function emojiForType(type) {
  if (TYPE_EMOJI[type]) return TYPE_EMOJI[type];
  const t = String(type).toLowerCase();
  if (t.includes("medical") || t.includes("ems")) return "ðŸš‘";
  if (t.includes("rescue")) return "ðŸ›Ÿ";
  if (t.includes("structure")) return "ðŸ ðŸ”¥";
  if (t.includes("brush") || t.includes("veg")) return "ðŸŒ¿ðŸ”¥";
  if (t.includes("fire")) return "ðŸ”¥";
  if (t.includes("haz")) return "â˜£ï¸";
  if (t.includes("alarm")) return "ðŸ””";
  if (t.includes("traffic") || t.includes("collision") || t === "tc") return "ðŸš—ðŸ’¥";
  return DEFAULT_EMOJI;
}

/** Render */
function render(items) {
  const list = $("list");
  const empty = $("empty");
  list.innerHTML = "";
  markersLayer.clearLayers();
  markerById.clear();

  $("countText").textContent = `${items.length} active`;

  if (!items.length) {
    empty.classList.remove("hidden");
    return;
  }
  empty.classList.add("hidden");

  const frag = document.createDocumentFragment();

  items.forEach((x, idx) => {
    const row = document.createElement("div");
    const base = (idx % 2 === 0 ? "row-a" : "row-b");
    row.className = base + " px-4 sm:px-5 py-3 cursor-pointer" + (newIds.has(x.id) ? " new-call" : "");

    const statusChip = statusToChip(x.status);

    row.innerHTML = `
      <div class="tbl">
        <div class="mono text-xs sm:text-sm text-zinc-200 truncate" title="${escapeAttr(x.dateStr)}">
          ${x.dateStr ? escapeHtml(x.dateStr) : "<span style='color:rgba(255,255,255,.45)'>â€”</span>"}
        </div>

        <div class="text-lg leading-none" title="${escapeAttr(x.type)}">
          ${escapeHtml(x.emoji)}
        </div>

        <div class="min-w-0">
          <a href="${escapeAttr(googleMapsUrl(x))}" target="_blank" rel="noopener"
             class="text-blue-400 hover:underline text-sm sm:text-[15px] truncate block"
             title="Open in Google Maps">
            ${escapeHtml(x.locationText)}
          </a>
          <div class="text-xs text-zinc-400 truncate">${escapeHtml(x.type)}</div>
        </div>

        <div class="col-units mono text-xs sm:text-sm text-zinc-200 truncate" title="${escapeAttr(x.units)}">
          ${x.units ? escapeHtml(x.units) : "<span style='color:rgba(255,255,255,.35)'>â€”</span>"}
        </div>

        <div class="col-status">
          ${statusChip}
        </div>
      </div>
    `;

    row.addEventListener("click", (e) => {
      if (e.target && e.target.closest && e.target.closest("a")) return;
      focusIncident(x.id, x.lat, x.lng);
    });

    frag.appendChild(row);

    if (x.lat != null && x.lng != null) {
      const popup = `
        <div style="min-width:220px">
          <div style="font-size:18px">${escapeHtml(x.emoji)} <b>${escapeHtml(x.type)}</b></div>
          <div style="margin-top:6px">${escapeHtml(x.locationText)}</div>
          ${x.units ? `<div style="margin-top:6px"><b>Units:</b> ${escapeHtml(x.units)}</div>` : ""}
          ${x.status ? `<div style="margin-top:4px"><b>Status:</b> ${escapeHtml(x.status)}</div>` : ""}
          ${x.dateStr ? `<div style="margin-top:6px; color:#777; font-size:12px">${escapeHtml(x.dateStr)}</div>` : ""}
          <div style="margin-top:6px">
            <a href="${escapeAttr(googleMapsUrl(x))}" target="_blank" rel="noopener"
               style="color:#2563eb;text-decoration:underline;">Open in Google Maps</a>
          </div>
        </div>
      `;
      const marker = L.marker([x.lat, x.lng]).bindPopup(popup);
      marker.addTo(markersLayer);
      markerById.set(x.id, marker);
    }
  });

  list.appendChild(frag);
}

/** Status chip (color coded) */
function statusToChip(statusRaw){
  const s = String(statusRaw || "").trim();
  const lower = s.toLowerCase();

  let bg = "rgba(255,255,255,.08)";
  let bd = "rgba(255,255,255,.14)";
  let tx = "rgba(255,255,255,.92)";

  if (!s) {
    tx = "rgba(255,255,255,.55)";
    return `<span class="chip" style="background:${bg};border-color:${bd};color:${tx}">â€”</span>`;
  }

  if (lower.includes("en route") || lower.includes("responding")) {
    bg = "rgba(245,158,11,.16)";   // amber
    bd = "rgba(245,158,11,.35)";
  } else if (lower.includes("on scene") || lower.includes("onscene") || lower.includes("arrived")) {
    bg = "rgba(16,185,129,.16)";   // emerald
    bd = "rgba(16,185,129,.35)";
  } else if (lower.includes("staged") || lower.includes("stand by") || lower.includes("standby")) {
    bg = "rgba(59,130,246,.16)";   // blue
    bd = "rgba(59,130,246,.35)";
  } else if (lower.includes("clear") || lower.includes("closed") || lower.includes("complete") || lower.includes("cleared")) {
    bg = "rgba(148,163,184,.14)";  // slate
    bd = "rgba(148,163,184,.30)";
    tx = "rgba(255,255,255,.80)";
  }

  return `<span class="chip mono" style="background:${bg};border-color:${bd};color:${tx}">${escapeHtml(s)}</span>`;
}

/** "Updated ..." label */
function computeLastUpdatedLabel(items){
  if (!items || !items.length) return "";
  // Use most recent responseDate, already sorted newest first
  const s = String(items[0].dateStr || "").trim();
  return s;
}

/** Map helpers */
function focusIncident(id, lat, lng) {
  if (lat == null || lng == null) return;
  const m = markerById.get(id);
  map.setView([lat, lng], Math.max(map.getZoom(), 14));
  if (m) m.openPopup();
}

function fitMapToMarkers() {
  const bounds = markersLayer.getBounds();
  if (bounds.isValid()) map.fitBounds(bounds.pad(0.15));
  else map.setView([DEFAULT_VIEW.lat, DEFAULT_VIEW.lng], DEFAULT_VIEW.zoom);
}

/** URL */
function googleMapsUrl(x) {
  if (x.lat != null && x.lng != null) {
    return `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(`${x.lat},${x.lng}`)}`;
  }
  return `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(x.locationText || "")}`;
}

/** Status dot */
function setStatus(level, text) {
  $("statusText").textContent = text;
  const dot = $("statusDot");
  dot.classList.remove("bg-white/40","bg-emerald-400","bg-amber-400","bg-rose-400");
  if (level === "ok") dot.classList.add("bg-emerald-400");
  else if (level === "loading") dot.classList.add("bg-amber-400");
  else if (level === "error") dot.classList.add("bg-rose-400");
  else dot.classList.add("bg-white/40");
}

/** helpers */
function numOrNull(v) {
  const n = Number(v);
  return Number.isFinite(n) ? n : null;
}
function tryParseTime(s) {
  const m = String(s || "").trim().match(/^(\d{1,2})\/(\d{1,2})\/(\d{2,4})\s+(\d{1,2}):(\d{2})/);
  if (!m) return 0;
  const mm = Number(m[1]), dd = Number(m[2]);
  let yy = Number(m[3]); if (yy < 100) yy = 2000 + yy;
  const hh = Number(m[4]), min = Number(m[5]);
  return new Date(yy, mm-1, dd, hh, min, 0).getTime();
}
function escapeHtml(s) {
  return String(s ?? "").replace(/[&<>"']/g, c => ({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
  })[c]);
}
function escapeAttr(s) { return escapeHtml(s).replace(/"/g, "&quot;"); }
</script>
</body>
</html>
