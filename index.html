<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>VC Incident Watch</title>

  <link rel="preconnect" href="https://unpkg.com" crossorigin>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
          integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

  <style>
    :root{
      --bg:#000;
      --ink:#f4f4f5;
      --muted:rgba(255,255,255,.7);
      --muted2:rgba(255,255,255,.45);
      --link:#60a5fa;

      --hdr:#8c1111;
      --hdrOutline:#000;

      --card:rgba(255,255,255,.03);
      --cardBorder:rgba(255,255,255,.08);

      --rowA:rgba(255,255,255,.02);
      --rowB:rgba(255,255,255,.04);

      --greenLine:rgba(16,185,129,.35);
      --shadow:rgba(0,0,0,.55);
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background:var(--bg);
      color:var(--ink);
    }
    a{ color:var(--link); text-decoration:none; }
    a:hover{ text-decoration:underline; }

    header{ position:sticky; top:0; z-index:50; background:var(--bg); }
    header .bar{
      background:var(--hdr);
      outline:2px solid var(--hdrOutline);
      box-shadow: 0 6px 18px var(--shadow);
    }
    .wrap{
      max-width:1120px; margin:0 auto; padding:14px 16px;
      display:flex; align-items:center; justify-content:space-between; gap:12px;
    }
    .title{ display:flex; flex-direction:column; gap:2px; }
    .title h1{ margin:0; font-size:18px; font-weight:750; letter-spacing:.2px; }
    .title p{ margin:0; font-size:12px; color:rgba(255,255,255,.82); }

    .statusBox{ display:flex; align-items:center; gap:10px; white-space:nowrap; font-size:12px; }
    .dot{ width:10px;height:10px;border-radius:999px; background:rgba(255,255,255,.35); box-shadow:0 0 0 2px rgba(0,0,0,.25) inset; }
    .dot.ok{ background:#34d399; }
    .dot.wait{ background:#fbbf24; }
    .dot.err{ background:#fb7185; }

    main{ max-width:1120px; margin:16px auto 28px; padding:0 16px; }

    .card{
      background:var(--card);
      border:1px solid var(--cardBorder);
      border-radius:14px;
      overflow:hidden;
      box-shadow: 0 10px 30px rgba(0,0,0,.5);
    }

    .sectionBar{
      background:#0d1c2f;
      border-bottom:1px solid rgba(255,255,255,.10);
      padding:14px 16px;
      display:flex; justify-content:space-between; align-items:center; gap:12px;
    }
    .sectionBar .left{ display:flex; align-items:baseline; gap:12px; flex-wrap:wrap; }
    .sectionBar .label{ font-weight:800; font-size:16px; }
    .sectionBar .sub{ color:rgba(255,255,255,.7); font-size:12px; }
    .sectionBar .right{ color:rgba(255,255,255,.8); font-size:12px; white-space:nowrap; }

    .tblHead{
      background:#060607;
      border-top:1px solid rgba(255,255,255,.08);
      border-bottom:1px solid rgba(255,255,255,.08);
      padding:10px 16px;
      color:rgba(255,255,255,.72);
      font-size:11px;
      letter-spacing:.18em;
      text-transform:uppercase;
    }

    .tbl{
      display:grid;
      grid-template-columns: 140px 64px 1fr 240px 140px;
      gap:12px;
      align-items:center;
      padding:0 16px;
    }

    .row{
      border-bottom:1px solid rgba(255,255,255,.06);
      box-shadow: inset 0 -1px 0 var(--greenLine);
      padding:14px 0;
    }
    .row:nth-child(odd){ background:var(--rowA); }
    .row:nth-child(even){ background:var(--rowB); }

    .date{
      font-variant-numeric: tabular-nums;
      color:rgba(255,255,255,.88);
      font-size:13px;
      white-space:nowrap;
    }
    .icon{ font-size:20px; line-height:1; display:flex; align-items:center; justify-content:center; }
    .addr a{ display:block; font-size:14px; font-weight:700; color:var(--link); }
    .addr .typeText{
      margin-top:3px;
      font-size:12px;
      color:rgba(255,255,255,.55);
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
      max-width:100%;
    }

    .mono{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      font-size:12px;
      color:rgba(255,255,255,.85);
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }

    .chip{
      display:inline-flex; align-items:center; justify-content:center;
      padding:6px 10px; border-radius:999px;
      font-size:12px; font-weight:750;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.04);
      color:rgba(255,255,255,.92);
      white-space:nowrap;
    }
    .chip.green{ border-color:rgba(34,197,94,.35); background:rgba(34,197,94,.10); }
    .chip.amber{ border-color:rgba(245,158,11,.35); background:rgba(245,158,11,.10); }
    .chip.slate{ border-color:rgba(148,163,184,.30); background:rgba(148,163,184,.10); }

    .helper{ padding:10px 16px; color:rgba(255,255,255,.4); font-size:11px; }

    .mapCard{ margin-top:18px; }
    .mapTop{
      display:flex; align-items:center; justify-content:space-between;
      padding:14px 16px;
      background:rgba(255,255,255,.04);
      border-bottom:1px solid rgba(255,255,255,.10);
    }
    .mapTop .label{ font-weight:800; font-size:16px; }
    .btn{
      appearance:none;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.06);
      color:rgba(255,255,255,.92);
      border-radius:10px;
      padding:8px 12px;
      font-size:12px;
      font-weight:750;
      cursor:pointer;
    }
    .btn:hover{ background:rgba(255,255,255,.10); }
    #map{ height:360px; background:#111; }

    .mobileMeta{ display:none; }
    @media (max-width: 760px){
      .tblHead{ display:none; }
      .tbl{ grid-template-columns: 118px 44px 1fr; gap:10px; }
      .addr a{ white-space:normal; overflow:visible; text-overflow:unset; line-height:1.15; }
      .desktopUnits, .desktopStatus{ display:none; }
      .mobileMeta{
        display:flex; flex-wrap:wrap; gap:8px; margin-top:6px; align-items:center;
      }
      .mobileUnits{
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
        font-size:12px; color:rgba(255,255,255,.82);
        white-space:normal;
      }
      #map{ height:420px; }
    }
  </style>
</head>

<body>
<header>
  <div class="bar">
    <div class="wrap">
      <div class="title">
        <h1>VC Incident Watch</h1>
        <p>Live Ventura County incidents</p>
      </div>
      <div class="statusBox">
        <span class="dot" id="dot"></span>
        <span id="statusText">Idle</span>
      </div>
    </div>
  </div>
</header>

<main>
  <section class="card">
    <div class="sectionBar">
      <div class="left">
        <div class="label">Active Calls</div>
        <div class="sub" id="updatedAt">Updated â€”</div>
      </div>
      <div class="right" id="activeCount">â€” active</div>
    </div>
    <div id="rows"></div>
  </section>

  <section class="card mapCard">
    <div class="mapTop">
      <div class="label">Map</div>
      <button class="btn" id="fitBtn">Fit Map</button>
    </div>
    <div id="map"></div>
  </section>
</main>

<script>
const API_URL = "https://firefeeds.venturacounty.gov/api/incidents";
let map, markersLayer;
let lastIncidents = [];

const dot = document.getElementById("dot");
const statusText = document.getElementById("statusText");
const rowsEl = document.getElementById("rows");
const updatedAtEl = document.getElementById("updatedAt");
const activeCountEl = document.getElementById("activeCount");

function setStatus(state, text){
  dot.classList.remove("ok","wait","err");
  if(state === "ok") dot.classList.add("ok");
  if(state === "wait") dot.classList.add("wait");
  if(state === "err") dot.classList.add("err");
  statusText.textContent = text;
}

function emojiFor(typeText){
  const t = (typeText || "").toLowerCase();
  if (t === "1e" || t.includes("gas")) return "âš ï¸";
  if (t.includes("medical") || t.includes("ems") || t.includes("ambul")) return "ðŸš‘";
  if (t.includes("rescue")) return "ðŸ›Ÿ";
  if (t.includes("water")) return "ðŸŒŠ";
  if (t.includes("structure")) return "ðŸ ðŸ”¥";
  if (t.includes("fire")) return "ðŸ”¥";
  if (t.includes("vegetation") || t.includes("brush")) return "ðŸŒ¿ðŸ”¥";
  if (t.includes("haz") || t.includes("hazmat")) return "â˜£ï¸";
  if (t.includes("traffic") || t.includes("tc") || t.includes("collision")) return "ðŸš—ðŸ’¥";
  return "ðŸ“";
}

function render(){
  rowsEl.innerHTML = "";
  activeCountEl.textContent = `${lastIncidents.length} active`;
  lastIncidents.forEach(x=>{
    const typeLabel = x.type === "1E" ? "Gas Leak" : x.type;
    rowsEl.innerHTML += `
      <div class="row">
        <div class="tbl">
          <div class="date">${x.dateStr}</div>
          <div class="icon">${emojiFor(typeLabel)}</div>
          <div class="addr">
            <a target="_blank" href="https://maps.google.com/?q=${encodeURIComponent(x.fullAddress)}">${x.fullAddress}</a>
            <div class="typeText">${typeLabel}</div>
          </div>
          <div class="mono">${x.units || "â€”"}</div>
          <div>${x.status || "â€”"}</div>
        </div>
      </div>`;
  });
}

async function fetchIncidents(){
  setStatus("wait","Refreshingâ€¦");
  const res = await fetch(API_URL);
  const data = await res.json();
  lastIncidents = data;
  updatedAtEl.textContent = `Updated ${new Date().toLocaleTimeString()}`;
  render();
  setStatus("ok","Updated");
}

fetchIncidents();
setInterval(fetchIncidents, 60000);
</script>

</body>
</html>