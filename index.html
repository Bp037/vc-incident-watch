<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>VC Incident Watch</title>
  <style>
    body { margin:0; font-family:system-ui; background:#0b0b0b; color:#f1f1f1; }
    header { background:#8f1414; padding:20px; }
    header h1 { margin:0; font-size:22px; font-weight:800; }
    .tabs { padding:10px; }
    .tab { background:#222; color:white; padding:8px 12px; border-radius:6px; border:none; cursor:pointer; margin-right:5px; }
    .tab.active { background:#555; }
    table { width:100%; border-collapse:collapse; }
    th, td { padding:8px; border-bottom:1px solid #333; font-size:13px; }
    th { background:#111; color:#aaa; position:sticky; top:0; }
    .error { color:#ffbdbd; padding:10px; }
  </style>
</head>
<body>
  <header>
    <h1>VC Incident Watch</h1>
    <div id="status">Loading…</div>
  </header>

  <div class="tabs">
    <button class="tab active" id="tabVCFD">VCFD</button>
    <button class="tab" id="tabCHP">CHP</button>
  </div>

  <div id="error" class="error"></div>

  <table>
    <thead id="thead"></thead>
    <tbody id="tbody"><tr><td>Loading…</td></tr></tbody>
  </table>

  <script>
    const tabVCFD = document.getElementById("tabVCFD");
    const tabCHP = document.getElementById("tabCHP");
    const tbody = document.getElementById("tbody");
    const thead = document.getElementById("thead");
    const statusEl = document.getElementById("status");
    const errorEl = document.getElementById("error");

    let active = "VCFD";
    let data = null;

    tabVCFD.onclick = () => setActive("VCFD");
    tabCHP.onclick = () => setActive("CHP");

    function setActive(which) {
      active = which;
      tabVCFD.classList.toggle("active", which === "VCFD");
      tabCHP.classList.toggle("active", which === "CHP");
      render();
    }

    async function load() {
      try {
        const res = await fetch("/api/incidents");
        const json = await res.json();
        if (!json.ok) throw new Error(json.error);
        data = json;
        statusEl.textContent = "Updated " + new Date(json.updatedAt).toLocaleTimeString();
        render();
      } catch (e) {
        errorEl.textContent = e.message;
      }
    }

    function render() {
      if (!data) return;

      if (active === "VCFD") {
        thead.innerHTML = "<tr><th>Time</th><th>Type</th><th>Location</th><th>City</th></tr>";
        tbody.innerHTML = data.vcfd.incidents.map(i => `
          <tr>
            <td>${i.dateTime}</td>
            <td>${i.type}</td>
            <td>${i.location}</td>
            <td>${i.city}</td>
          </tr>
        `).join("");
      }

      if (active === "CHP") {
        thead.innerHTML = "<tr><th>Time</th><th>Type</th><th>Location</th><th>Lat</th><th>Lon</th></tr>";
        tbody.innerHTML = data.chp.incidents.map(i => `
          <tr>
            <td>${i.dateTime}</td>
            <td>${i.type}</td>
            <td>${i.location}</td>
            <td>${i.latitude?.toFixed(5)}</td>
            <td>${i.longitude?.toFixed(5)}</td>
          </tr>
        `).join("");
      }
    }

    load();
    setInterval(load, 60000);
  </script>
</body>
</html>
